<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRIB WIND ‚Äî Chicago Racing Weather</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #070c14;
    --surface: #0d1622;
    --surface2: #111d2e;
    --border: #1e3050;
    --accent: #00d4ff;
    --accent2: #ff6b35;
    --accent3: #39ff8c;
    --warn: #ffb830;
    --danger: #ff3d5a;
    --text: #e8f4ff;
    --muted: #5a7a9a;
    --muted2: #3a5570;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 16px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Radial glow */
  body::after {
    content: '';
    position: fixed;
    top: -30%;
    left: 50%;
    transform: translateX(-50%);
    width: 80vw;
    height: 60vh;
    background: radial-gradient(ellipse, rgba(0,100,180,0.12) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(7,12,20,0.9);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .brand {
    display: flex;
    align-items: baseline;
    gap: 12px;
  }

  .brand-name {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 22px;
    letter-spacing: 0.08em;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,212,255,0.4);
  }

  .brand-sub {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .live-dot {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--accent3);
    letter-spacing: 0.1em;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent3);
    box-shadow: 0 0 8px var(--accent3);
    animation: pulse 2s infinite;
  }

  .dot.loading { background: var(--warn); box-shadow: 0 0 8px var(--warn); }
  .dot.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); animation: none; }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  .update-time {
    font-size: 11px;
    color: var(--muted);
  }

  .refresh-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--accent);
    padding: 6px 14px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: 0.1em;
    transition: all 0.2s;
  }
  .refresh-btn:hover { background: rgba(0,212,255,0.08); border-color: var(--accent); }

  /* ‚îÄ‚îÄ MAIN GRID ‚îÄ‚îÄ */
  .main-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    grid-template-rows: auto auto;
    gap: 16px;
    padding: 20px 32px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* ‚îÄ‚îÄ HERO WIND ‚îÄ‚îÄ */
  .hero-wind {
    grid-column: 1;
    grid-row: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  .hero-wind::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 30%, rgba(0,212,255,0.06), transparent 70%);
  }

  .section-label {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
    align-self: flex-start;
  }

  /* Wind compass */
  .compass-wrap {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 8px auto 20px;
  }

  .compass-ring {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .compass-ring::before {
    content: '';
    position: absolute;
    inset: 8px;
    border-radius: 50%;
    border: 1px solid rgba(0,212,255,0.15);
  }

  .compass-labels {
    position: absolute;
    inset: 0;
  }

  .compass-label {
    position: absolute;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    color: var(--muted);
    transform: translate(-50%, -50%);
  }
  .compass-label.n { top: 14px; left: 50%; color: var(--accent); }
  .compass-label.s { bottom: 4px; left: 50%; top: auto; transform: translateX(-50%); }
  .compass-label.e { right: 8px; top: 50%; transform: translateY(-50%); }
  .compass-label.w { left: 8px; top: 50%; transform: translateY(-50%); }

  .wind-arrow-wrap {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .wind-arrow {
    width: 4px;
    height: 80px;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .arrow-tail {
    width: 4px;
    flex: 1;
    background: linear-gradient(to top, transparent, rgba(0,212,255,0.3));
  }

  .arrow-head {
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 22px solid var(--accent);
    filter: drop-shadow(0 0 8px var(--accent));
  }

  .center-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 12px var(--accent);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  /* Tick marks */
  .tick-marks {
    position: absolute;
    inset: 0;
  }

  .big-numbers {
    text-align: center;
    margin: 4px 0;
  }

  .wind-speed-display {
    font-family: 'Syne', sans-serif;
    font-size: 56px;
    font-weight: 800;
    line-height: 1;
    color: var(--accent);
    text-shadow: 0 0 30px rgba(0,212,255,0.4);
    letter-spacing: -0.02em;
  }

  .wind-unit {
    font-size: 14px;
    color: var(--muted);
    margin-top: 2px;
    letter-spacing: 0.1em;
  }

  .wind-dir-text {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    margin: 4px 0;
  }

  .wind-deg {
    font-size: 13px;
    color: var(--muted);
  }

  .gust-row {
    display: flex;
    gap: 20px;
    margin-top: 16px;
    width: 100%;
  }

  .mini-stat {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    text-align: center;
  }

  .mini-stat-label {
    font-size: 9px;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
  }

  .mini-stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--warn);
    margin-top: 2px;
  }

  .mini-stat-value.green { color: var(--accent3); }
  .mini-stat-value.blue { color: var(--accent); }

  /* ‚îÄ‚îÄ TREND PANEL ‚îÄ‚îÄ */
  .trend-panel {
    grid-column: 2;
    grid-row: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .tab-group {
    display: flex;
    gap: 4px;
    background: var(--surface2);
    border-radius: 6px;
    padding: 3px;
  }

  .tab {
    padding: 5px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.08em;
    border-radius: 4px;
    border: none;
    background: none;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--border);
    color: var(--accent);
  }

  /* Chart canvas */
  .chart-container {
    position: relative;
    height: 220px;
  }

  canvas { width: 100% !important; }

  /* ‚îÄ‚îÄ BOTTOM GRID ‚îÄ‚îÄ */
  .bottom-grid {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
  }

  /* ‚îÄ‚îÄ FORECAST PANEL ‚îÄ‚îÄ */
  .forecast-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }

  .forecast-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(30,48,80,0.5);
    gap: 14px;
  }

  .forecast-item:last-child { border-bottom: none; }

  .forecast-time {
    font-size: 11px;
    color: var(--muted);
    width: 48px;
    flex-shrink: 0;
  }

  .forecast-arrow {
    font-size: 20px;
    width: 28px;
    text-align: center;
    transition: transform 0.3s;
  }

  .forecast-data {
    flex: 1;
  }

  .forecast-spd {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 18px;
    color: var(--text);
  }

  .forecast-dir {
    font-size: 11px;
    color: var(--muted);
    margin-top: 1px;
  }

  .forecast-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
    letter-spacing: 0.08em;
  }

  .badge-good { background: rgba(57,255,140,0.12); color: var(--accent3); border: 1px solid rgba(57,255,140,0.2); }
  .badge-ok { background: rgba(255,184,48,0.12); color: var(--warn); border: 1px solid rgba(255,184,48,0.2); }
  .badge-strong { background: rgba(255,61,90,0.12); color: var(--danger); border: 1px solid rgba(255,61,90,0.2); }

  /* ‚îÄ‚îÄ ANALYSIS PANEL ‚îÄ‚îÄ */
  .analysis-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }

  .trend-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: var(--surface2);
    border-radius: 8px;
    border-left: 3px solid var(--accent);
    margin-bottom: 12px;
  }

  .trend-indicator.warn { border-left-color: var(--warn); }
  .trend-indicator.danger { border-left-color: var(--danger); }
  .trend-indicator.good { border-left-color: var(--accent3); }

  .trend-icon { font-size: 20px; }

  .trend-text { font-size: 12px; line-height: 1.5; }
  .trend-text strong { color: var(--accent); display: block; font-size: 13px; margin-bottom: 2px; }
  .trend-indicator.warn .trend-text strong { color: var(--warn); }
  .trend-indicator.danger .trend-text strong { color: var(--danger); }
  .trend-indicator.good .trend-text strong { color: var(--accent3); }

  /* ‚îÄ‚îÄ LOCAL KNOWLEDGE ‚îÄ‚îÄ */
  .local-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }

  .tip-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 10px;
    position: relative;
  }

  .tip-card::before {
    content: attr(data-icon);
    position: absolute;
    top: 12px;
    right: 14px;
    font-size: 18px;
    opacity: 0.6;
  }

  .tip-condition {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 4px;
  }

  .tip-text {
    font-size: 12px;
    line-height: 1.6;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ RACE CONDITIONS METER ‚îÄ‚îÄ */
  .race-meter {
    margin-top: 16px;
    padding: 16px;
    background: var(--surface2);
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .meter-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .meter-bar-wrap {
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 6px;
  }

  .meter-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 1s ease;
    background: linear-gradient(90deg, var(--accent3), var(--warn), var(--danger));
    background-size: 300% 100%;
    background-position: var(--bar-pos, 0%) 0%;
  }

  .meter-scale {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    color: var(--muted);
  }

  .meter-score {
    font-family: 'Syne', sans-serif;
    font-size: 36px;
    font-weight: 800;
    text-align: center;
    margin: 8px 0 4px;
  }

  .meter-description {
    font-size: 11px;
    text-align: center;
    color: var(--muted);
  }

  /* ‚îÄ‚îÄ HISTORY TREND ‚îÄ‚îÄ */
  .history-row {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    align-items: flex-end;
    height: 48px;
  }

  .hist-bar {
    flex: 1;
    background: rgba(0,212,255,0.2);
    border-radius: 2px 2px 0 0;
    position: relative;
    transition: all 0.3s;
    cursor: pointer;
  }

  .hist-bar:hover { background: rgba(0,212,255,0.4); }
  .hist-bar.active { background: var(--accent); }

  /* ‚îÄ‚îÄ NOAA FEED ‚îÄ‚îÄ */
  .data-feed {
    grid-column: 1 / -1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
  }

  .feed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .feed-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .feed-table th {
    text-align: left;
    font-size: 12px;
    letter-spacing: 0.12em;
    color: var(--muted);
    text-transform: uppercase;
    padding: 6px 12px 10px;
    border-bottom: 1px solid var(--border);
  }

  .feed-table td {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(30,48,80,0.4);
    color: var(--text);
  }

  .feed-table tr:last-child td { border-bottom: none; }
  .feed-table tr:hover td { background: rgba(0,212,255,0.03); }

  .dir-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
  }

  .dir-mini-arrow {
    font-size: 14px;
  }

  /* ‚îÄ‚îÄ CHANGE ARROWS ‚îÄ‚îÄ */
  .change-up { color: var(--danger); }
  .change-down { color: var(--accent3); }
  .change-same { color: var(--muted); }

  /* ‚îÄ‚îÄ LOADING STATE ‚îÄ‚îÄ */
  .loading-shimmer {
    background: linear-gradient(90deg, var(--surface2) 25%, rgba(30,48,80,0.5) 50%, var(--surface2) 75%);
    background-size: 400% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
    height: 20px;
    width: 100%;
  }

  @keyframes shimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
  }

  /* ‚îÄ‚îÄ MOBILE NOTICE ‚îÄ‚îÄ */
  .mobile-notice {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, rgba(0,212,255,0.08), rgba(57,255,140,0.05));
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 12px;
    padding: 20px 24px;
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }

  .notice-icon { font-size: 28px; flex-shrink: 0; margin-top: 2px; }

  .notice-content h3 {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 6px;
  }

  .notice-content p {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.7;
    margin-bottom: 10px;
  }

  .code-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 16px;
    font-size: 11px;
    color: var(--accent3);
    margin-top: 8px;
    line-height: 1.8;
  }

  .code-block span { color: var(--muted); }

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .hero-wind, .trend-panel, .forecast-panel, .analysis-panel, .local-panel, .data-feed {
    animation: fadeSlideIn 0.5s ease both;
  }

  .trend-panel { animation-delay: 0.05s; }
  .forecast-panel { animation-delay: 0.1s; }
  .analysis-panel { animation-delay: 0.15s; }
  .local-panel { animation-delay: 0.2s; }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 1000px) {
    .main-grid {
      grid-template-columns: 1fr;
      padding: 16px;
    }
    .trend-panel { grid-column: 1; grid-row: 2; }
    .bottom-grid { grid-template-columns: 1fr; }
  }

  /* Divider line  */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 14px 0;
  }

  /* Inline badge */
  .inline-badge {
    display: inline-block;
    padding: 1px 7px;
    border-radius: 3px;
    font-size: 9px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: rgba(0,212,255,0.1);
    color: var(--accent);
    border: 1px solid rgba(0,212,255,0.2);
    margin-left: 6px;
    vertical-align: middle;
  }

  .source-tag {
    font-size: 9px;
    color: var(--muted2);
    letter-spacing: 0.08em;
  }

  /* Race condition score color */
  .score-excellent { color: var(--accent3); }
  .score-good { color: var(--accent); }
  .score-fair { color: var(--warn); }
  .score-rough { color: var(--danger); }

  .sparkline-label {
    font-size: 9px;
    color: var(--muted);
    text-align: right;
    margin-top: 4px;
  }

  /* ‚îÄ‚îÄ WIND ROSE mini ‚îÄ‚îÄ‚îÄ */
  .windrose-mini {
    margin: 12px auto 0;
    position: relative;
    width: 90px;
    height: 90px;
  }

  /* ‚îÄ‚îÄ 1-HOUR PREDICTION PANEL ‚îÄ‚îÄ */
  .prediction-panel {
    grid-column: 1 / -1;
    background: var(--surface);
    border: 1px solid rgba(0,212,255,0.25);
    border-radius: 12px;
    padding: 28px;
    position: relative;
    overflow: hidden;
  }

  .prediction-panel::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 20% 50%, rgba(0,212,255,0.04), transparent 60%),
                radial-gradient(ellipse at 80% 50%, rgba(57,255,140,0.03), transparent 60%);
    pointer-events: none;
  }

  .pred-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 22px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .pred-title-block {}

  .pred-title {
    font-family: 'Syne', sans-serif;
    font-size: 17px;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: 0.04em;
  }

  .pred-subtitle {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.12em;
    margin-top: 3px;
  }

  .pred-timestamp {
    font-size: 10px;
    color: var(--muted2);
    letter-spacing: 0.08em;
  }

  /* Main prediction row */
  .pred-main-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 200px;
    gap: 16px;
    margin-bottom: 22px;
  }

  @media (max-width: 900px) {
    .pred-main-row { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 600px) {
    .pred-main-row { grid-template-columns: 1fr; }
  }

  .pred-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    position: relative;
  }

  .pred-card-label {
    font-size: 9px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .pred-card-value {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
    letter-spacing: -0.01em;
  }

  .pred-card-unit {
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
    font-family: 'DM Mono', monospace;
  }

  .pred-card-delta {
    font-size: 11px;
    margin-top: 6px;
    font-style: italic;
  }

  .delta-up   { color: var(--danger); }
  .delta-down { color: var(--accent3); }
  .delta-same { color: var(--muted); }

  /* Confidence gauge */
  .conf-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .conf-ring-wrap {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto;
  }

  .conf-ring-wrap svg { position: absolute; inset: 0; }

  .conf-center-text {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .conf-pct {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    line-height: 1;
  }

  .conf-label {
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.1em;
    margin-top: 2px;
  }

  .conf-level-text {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    margin-top: 10px;
    text-align: center;
    letter-spacing: 0.05em;
  }

  /* Signal rows */
  .pred-signals {
    border-top: 1px solid var(--border);
    padding-top: 18px;
  }

  .pred-signals-title {
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 12px;
  }

  .signal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 10px;
  }

  .signal-row {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  .signal-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

  .signal-content {}

  .signal-name {
    font-size: 11px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .signal-weight {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 3px;
    background: rgba(0,212,255,0.1);
    color: var(--accent);
    border: 1px solid rgba(0,212,255,0.15);
    letter-spacing: 0.08em;
  }

  .signal-weight.high   { background: rgba(57,255,140,0.1); color: var(--accent3); border-color: rgba(57,255,140,0.2); }
  .signal-weight.medium { background: rgba(255,184,48,0.1); color: var(--warn); border-color: rgba(255,184,48,0.2); }
  .signal-weight.low    { background: rgba(90,122,154,0.1); color: var(--muted); border-color: rgba(90,122,154,0.2); }

  .signal-desc {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
  }

  .signal-value {
    font-size: 11px;
    color: var(--text);
    font-style: italic;
    margin-top: 2px;
  }

  /* Method chips */
  .method-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 14px;
  }

  .method-chip {
    font-size: 10px;
    padding: 3px 10px;
    border-radius: 20px;
    background: rgba(30,48,80,0.8);
    border: 1px solid var(--border);
    color: var(--muted);
    letter-spacing: 0.07em;
  }

  .method-chip.active {
    background: rgba(0,212,255,0.08);
    border-color: rgba(0,212,255,0.3);
    color: var(--accent);
  }

  /* Prediction direction arrow */
  .pred-dir-arrow {
    font-size: 40px;
    text-align: center;
    line-height: 1;
    filter: drop-shadow(0 0 8px var(--accent3));
  }

  .disclaimer-bar {
    margin-top: 16px;
    padding: 10px 14px;
    background: rgba(255,184,48,0.05);
    border: 1px solid rgba(255,184,48,0.15);
    border-radius: 6px;
    font-size: 10px;
    color: var(--muted);
    line-height: 1.7;
    letter-spacing: 0.03em;
  }

  .disclaimer-bar strong { color: var(--warn); }

  /* ‚îÄ‚îÄ DUAL HORIZON PREDICTION ‚îÄ‚îÄ */
  .horizon-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .horizon-tab {
    padding: 6px 18px;
    border-radius: 20px;
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.06em;
    cursor: default;
    border: 1px solid var(--border);
    color: var(--muted);
    background: transparent;
    transition: all 0.2s;
  }
  .horizon-tab.primary {
    background: rgba(0,212,255,0.1);
    border-color: rgba(0,212,255,0.4);
    color: var(--accent);
  }
  .horizon-tab.secondary {
    background: rgba(90,122,154,0.08);
    border-color: rgba(90,122,154,0.2);
    color: var(--muted);
    font-size: 11px;
  }
  .horizon-section-label {
    font-size: 9px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--muted2);
    margin-bottom: 10px;
    padding-left: 2px;
  }
  .pred-30-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 8px;
  }
  .pred-30-card {
    background: rgba(0,212,255,0.04);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 10px;
    padding: 14px 16px;
    text-align: center;
  }
  .pred-30-label {
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .pred-30-value {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 4px;
  }
  .pred-30-unit {
    font-size: 9px;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .pred-30-delta {
    font-size: 10px;
    color: var(--muted);
  }
  .pred-60-divider {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 16px 0 14px;
    color: var(--muted2);
    font-size: 9px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }
  .pred-60-divider::before, .pred-60-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .conf-improvement {
    font-size: 10px;
    color: var(--accent3);
    margin-top: 4px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ MARINE FORECAST PANELS ‚îÄ‚îÄ */
  .marine-grid {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 900px) { .marine-grid { grid-template-columns: 1fr; } }

  .marine-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    animation: fadeSlideIn 0.5s ease both;
    animation-delay: 0.25s;
  }

  .marine-panel.nws  { border-color: rgba(255,184,48,0.25); }
  .marine-panel.meteo { border-color: rgba(57,255,140,0.2); }

  .marine-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 16px;
    gap: 12px;
    flex-wrap: wrap;
  }

  .marine-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.04em;
  }
  .marine-panel.nws  .marine-title { color: var(--warn); }
  .marine-panel.meteo .marine-title { color: var(--accent3); }

  .marine-issued {
    font-size: 10px;
    color: var(--muted2);
    letter-spacing: 0.06em;
    margin-top: 3px;
  }

  .marine-status {
    font-size: 10px;
    padding: 3px 10px;
    border-radius: 20px;
    letter-spacing: 0.08em;
    flex-shrink: 0;
  }
  .status-live  { background: rgba(57,255,140,0.1); color: var(--accent3); border: 1px solid rgba(57,255,140,0.25); }
  .status-error { background: rgba(255,61,90,0.1);  color: var(--danger);  border: 1px solid rgba(255,61,90,0.25); }
  .status-load  { background: rgba(90,122,154,0.1); color: var(--muted);   border: 1px solid rgba(90,122,154,0.2); }

  /* NWS text forecast periods */
  .nws-period {
    padding: 10px 0;
    border-bottom: 1px solid rgba(30,48,80,0.5);
  }
  .nws-period:last-child { border-bottom: none; }

  .nws-period-name {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--warn);
    margin-bottom: 4px;
  }

  .nws-period-text {
    font-size: 12px;
    line-height: 1.7;
    color: var(--text);
  }

  .nws-highlight {
    display: inline-block;
    background: rgba(255,184,48,0.1);
    border-radius: 3px;
    padding: 0 5px;
    color: var(--warn);
    font-weight: 500;
  }

  .nws-shift-alert {
    margin-top: 8px;
    padding: 8px 12px;
    background: rgba(255,61,90,0.08);
    border: 1px solid rgba(255,61,90,0.2);
    border-radius: 6px;
    font-size: 11px;
    color: var(--danger);
  }

  /* Open-Meteo hourly table */
  .meteo-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .meteo-table th {
    font-size: 12px;
    letter-spacing: 0.12em;
    color: var(--muted);
    text-transform: uppercase;
    padding: 4px 8px 8px;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }
  .meteo-table td {
    padding: 7px 8px;
    border-bottom: 1px solid rgba(30,48,80,0.35);
    color: var(--text);
  }
  .meteo-table tr:last-child td { border-bottom: none; }
  .meteo-table tr.now-row td { background: rgba(57,255,140,0.05); }
  .meteo-table tr.now-row td:first-child {
    color: var(--accent3);
    font-weight: 600;
  }

  .meteo-blend-note {
    margin-top: 14px;
    padding: 10px 14px;
    background: rgba(57,255,140,0.05);
    border: 1px solid rgba(57,255,140,0.15);
    border-radius: 6px;
    font-size: 10px;
    color: var(--muted);
    line-height: 1.7;
  }

  .model-delta-up   { color: var(--danger); }
  .model-delta-down { color: var(--accent3); }
  .model-delta-same { color: var(--muted); }

  /* ‚îÄ‚îÄ STATION NETWORK PANEL ‚îÄ‚îÄ */
  .station-network-panel {
    grid-column: 1 / -1;
    background: var(--surface);
    border: 1px solid rgba(0,212,255,0.15);
    border-radius: 16px;
    padding: 24px 28px;
    animation: fadeSlideIn 0.5s ease both;
    animation-delay: 0.2s;
  }
  .station-network-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 18px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .station-network-title {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent);
  }
  .station-network-subtitle {
    font-size: 10px;
    color: var(--muted2);
    margin-top: 2px;
    letter-spacing: 0.06em;
  }
  .station-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }
  @media (max-width: 900px) { .station-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 500px) { .station-grid { grid-template-columns: 1fr; } }

  .station-card {
    background: rgba(10,20,40,0.5);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    transition: border-color 0.3s;
  }
  .station-card.on-course {
    border-color: rgba(57,255,140,0.3);
    background: rgba(57,255,140,0.03);
  }
  .station-card.upstream {
    border-color: rgba(0,212,255,0.2);
  }
  .station-card.loading {
    opacity: 0.5;
  }
  .station-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .station-id {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 0.06em;
    color: var(--text);
  }
  .station-card.on-course .station-id { color: var(--accent3); }
  .station-role {
    font-size: 8px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 10px;
    background: rgba(90,122,154,0.15);
    color: var(--muted);
  }
  .station-card.on-course .station-role {
    background: rgba(57,255,140,0.12);
    color: var(--accent3);
  }
  .station-name {
    font-size: 10px;
    color: var(--muted);
    margin-bottom: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .station-wind-row {
    display: flex;
    align-items: baseline;
    gap: 6px;
    margin-bottom: 4px;
  }
  .station-wind-arrow {
    font-size: 18px;
    line-height: 1;
    color: var(--accent);
  }
  .station-wind-spd {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 800;
    color: var(--text);
    line-height: 1;
  }
  .station-wind-unit {
    font-size: 9px;
    color: var(--muted2);
    letter-spacing: 0.08em;
  }
  .station-wind-dir {
    font-size: 11px;
    color: var(--accent3);
    margin-bottom: 4px;
  }
  .station-gust {
    font-size: 10px;
    color: var(--warn);
  }
  .station-temp {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
  }
  .station-delta {
    font-size: 10px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--border);
    color: var(--muted);
    line-height: 1.5;
  }
  .station-delta .delta-up   { color: var(--danger); }
  .station-delta .delta-down { color: var(--accent3); }
  .station-status {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
  }
  .station-status.live   { background: var(--accent3); }
  .station-status.error  { background: var(--danger); }
  .station-status.load   { background: var(--muted2); }

  /* Lake breeze meter */
  .lb-meter-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }
  .lb-meter-label {
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted2);
    white-space: nowrap;
  }
  .lb-meter-bar-wrap {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    overflow: hidden;
  }
  .lb-meter-bar {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
    transition: width 1s ease;
  }
  .lb-meter-val {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--accent3);
    white-space: nowrap;
  }
  .lb-meter-note {
    font-size: 10px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ RACE STRATEGY PANEL ‚îÄ‚îÄ */
  .strategy-panel {
    grid-column: 1 / -1;
    background: var(--surface);
    border: 1px solid rgba(57,255,140,0.2);
    border-radius: 16px;
    padding: 28px 32px;
    animation: fadeSlideIn 0.5s ease both;
    animation-delay: 0.3s;
    position: relative;
    overflow: hidden;
  }
  .strategy-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent3), var(--accent), transparent);
  }
  .strategy-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .strategy-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 800;
    letter-spacing: 0.04em;
    color: var(--accent3);
  }
  .strategy-meta {
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--muted2);
    margin-top: 3px;
  }
  .strategy-confidence {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 10px;
    letter-spacing: 0.1em;
  }
  .strategy-conf-pip {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Side call banner */
  .side-call {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }
  .side-card {
    flex: 1;
    border-radius: 10px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .side-card.favored {
    background: rgba(57,255,140,0.07);
    border: 1px solid rgba(57,255,140,0.25);
  }
  .side-card.avoid {
    background: rgba(90,122,154,0.06);
    border: 1px solid rgba(90,122,154,0.18);
  }
  .side-card.split {
    background: rgba(255,184,48,0.06);
    border: 1px solid rgba(255,184,48,0.2);
  }
  .side-icon {
    font-size: 28px;
    line-height: 1;
    flex-shrink: 0;
  }
  .side-label {
    font-size: 9px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 4px;
  }
  .side-name {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 800;
    color: var(--text);
  }
  .side-card.favored .side-name { color: var(--accent3); }
  .side-card.split    .side-name { color: var(--warn); }
  .side-reason {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
    margin-top: 4px;
  }

  /* Strategy sections */
  .strategy-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }
  @media (max-width: 700px) { .strategy-sections { grid-template-columns: 1fr; } }

  .strategy-section {
    background: rgba(10,20,40,0.4);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
  }
  .strategy-section-title {
    font-size: 12px;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--muted2);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .strategy-bullets {
    list-style: none;
    padding: 0; margin: 0;
    display: flex;
    flex-direction: column;
    gap: 7px;
  }
  .strategy-bullet {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text);
    padding-left: 16px;
    position: relative;
  }
  .strategy-bullet::before {
    content: '‚ñ∏';
    position: absolute;
    left: 0;
    color: var(--accent3);
    font-size: 12px;
  }
  .strategy-bullet.warn::before { color: var(--warn); }
  .strategy-bullet.danger::before { color: var(--danger); }

  /* Narrative paragraph */
  .strategy-narrative {
    font-size: 14px;
    line-height: 1.85;
    color: var(--text);
    border-top: 1px solid var(--border);
    padding-top: 16px;
    margin-top: 4px;
  }
  .strategy-narrative strong { color: var(--accent3); }
  .strategy-narrative em { color: var(--warn); font-style: normal; }

  /* Alerts */
  .strategy-alert {
    margin-bottom: 16px;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.7;
    display: none;
  }
  .strategy-alert.danger {
    background: rgba(255,61,90,0.08);
    border: 1px solid rgba(255,61,90,0.25);
    color: var(--danger);
  }
  .strategy-alert.warn {
    background: rgba(255,184,48,0.07);
    border: 1px solid rgba(255,184,48,0.2);
    color: var(--warn);
  }

  /* ‚îÄ‚îÄ MOBILE (‚â§600px) ‚îÄ‚îÄ */
  @media (max-width: 600px) {

    /* Header: un-stick it, shrink padding, hide subtitle */
    header {
      position: relative;
      padding: 12px 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .brand-sub { display: none; }
    .brand-name { font-size: 20px; }

    /* Collapse status bar items */
    .status-bar { gap: 10px; }
    .update-time { font-size: 13px; }
    .live-dot { font-size: 13px; }

    /* Refresh button: icon only */
    .refresh-btn { font-size: 18px; padding: 6px 10px; letter-spacing: 0; }
    .refresh-btn-text { display: none; }

    /* Main grid: tighter padding */
    .main-grid {
      padding: 12px;
      gap: 12px;
    }

    /* Section labels (those tiny all-caps headers) */
    .section-label { font-size: 13px; letter-spacing: 0.12em; }

    /* Hero wind number: big and glanceable */
    .wind-speed-display { font-size: 88px; }
    .wind-unit { font-size: 17px; }
    .wind-dir-text { font-size: 38px; }
    .wind-deg { font-size: 16px; }

    /* Mini stats (Gust / Temp / RH) */
    .mini-stat-value { font-size: 26px; }
    .mini-stat-label { font-size: 12px; }

    /* Race condition score */
    .meter-score { font-size: 42px; }
    .meter-description { font-size: 14px; }
    .meter-label { font-size: 12px; }
    .meter-scale { font-size: 12px; }

    /* Chart: ensure it doesn't get squished */
    .chart-container { height: 200px; }
    .sparkline-label { font-size: 12px; }

    /* Tab buttons in chart header */
    .tab { font-size: 13px; padding: 6px 16px; }

    /* Bottom grid panels */
    .forecast-panel,
    .analysis-panel,
    .local-panel,
    .prediction-panel,
    .marine-panel,
    .station-network-panel,
    .strategy-panel {
      padding: 16px;
    }

    /* Forecast list */
    .forecast-time { font-size: 14px; }
    .forecast-spd { font-size: 22px; }
    .forecast-dir { font-size: 14px; }
    .forecast-arrow { font-size: 24px; }
    .forecast-badge { font-size: 13px; }

    /* Trend analysis */
    .trend-text { font-size: 15px; }
    .trend-text strong { font-size: 16px; }
    .trend-icon { font-size: 22px; }

    /* Local knowledge / tip cards */
    .tip-text { font-size: 15px; line-height: 1.7; }
    .tip-condition { font-size: 12px; }

    /* Prediction panel labels & values */
    .pred-title { font-size: 20px; }
    .pred-subtitle { font-size: 13px; }
    .pred-card-label { font-size: 12px; }
    .pred-card-value { font-size: 36px; }
    .pred-card-unit { font-size: 14px; }
    .pred-card-delta { font-size: 14px; }
    .horizon-section-label { font-size: 12px; }

    /* Pred +30/+60 cards */
    .pred-30-row { grid-template-columns: 1fr 1fr 1fr; }
    .pred-30-label { font-size: 12px; }
    .pred-30-value { font-size: 28px; }
    .pred-30-unit { font-size: 12px; }
    .pred-30-delta { font-size: 13px; }

    /* Confidence ring */
    .conf-pct { font-size: 26px; }
    .conf-label { font-size: 12px; }
    .conf-level-text { font-size: 15px; }

    /* Signal breakdown */
    .signal-grid { grid-template-columns: 1fr; }
    .signal-name { font-size: 14px; }
    .signal-desc { font-size: 13px; }
    .signal-value { font-size: 13px; }
    .signal-weight { font-size: 12px; }
    .pred-signals-title { font-size: 13px; }

    /* Station cards */
    .station-id { font-size: 16px; }
    .station-name { font-size: 13px; }
    .station-wind-spd { font-size: 28px; }
    .station-wind-dir { font-size: 14px; }
    .station-gust { font-size: 13px; }
    .station-temp { font-size: 13px; }
    .station-delta { font-size: 13px; }
    .station-role { font-size: 11px; }
    .station-network-title { font-size: 15px; }

    /* Marine / NWS */
    .nws-period-name { font-size: 13px; }
    .nws-period-text { font-size: 15px; line-height: 1.8; }
    .marine-title { font-size: 17px; }
    .marine-issued { font-size: 13px; }

    /* Open-Meteo table */
    .meteo-table td, .meteo-table th { padding: 7px 5px; font-size: 13px; }

    /* Feed table (GLERL history) */
    .feed-table td, .feed-table th { padding: 8px 8px; font-size: 13px; }

    /* Strategy panel */
    .strategy-title { font-size: 18px; }
    .side-name { font-size: 24px; }
    .side-reason { font-size: 14px; }
    .strategy-bullet { font-size: 14px; }
    .strategy-narrative { font-size: 15px; }
    .strategy-meta { font-size: 13px; }

    /* Trend panel */
    .trend-panel { padding: 16px; }

    /* Inline badges & chips */
    .inline-badge { font-size: 12px; }
    .method-chip { font-size: 13px; }
    .source-tag { font-size: 12px; }

    /* Disclaimer */
    .disclaimer-bar { font-size: 13px; }
  }

  /* ‚îÄ‚îÄ MOBILE LANDSCAPE (phone on its side) ‚îÄ‚îÄ */
  @media (max-height: 500px) and (orientation: landscape) {
    header {
      position: relative;
      padding: 8px 16px;
    }
  }
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<header>
  <div class="brand">
    <div class="brand-name">‚öì CRIB WIND</div>
    <div class="brand-sub">Harrison-Dever Crib ¬∑ Lake Michigan Racing</div>
  </div>
  <div class="status-bar">
    <div class="live-dot">
      <div class="dot" id="liveDot"></div>
      <span id="liveLabel">LIVE</span>
    </div>
    <div class="update-time" id="updateTime">‚Äî</div>
    <button class="refresh-btn" onclick="loadData()">‚Üª <span class="refresh-btn-text">REFRESH</span></button>
  </div>
</header>

<div class="main-grid">

  <!-- HERO: Current Wind -->
  <div class="hero-wind">
    <div class="section-label">Harrison-Dever Crib ¬∑ Now</div>

    <div class="compass-wrap">
      <div class="compass-ring">
        <div class="compass-labels">
          <span class="compass-label n">N</span>
          <span class="compass-label s">S</span>
          <span class="compass-label e">E</span>
          <span class="compass-label w">W</span>
        </div>
        <!-- SVG tick marks -->
        <svg style="position:absolute;inset:0;width:100%;height:100%;" viewBox="0 0 200 200">
          <g id="ticks"></g>
        </svg>
        <div class="wind-arrow-wrap" id="arrowWrap">
          <div class="wind-arrow">
            <div class="arrow-head"></div>
            <div class="arrow-tail"></div>
          </div>
        </div>
        <div class="center-dot"></div>
      </div>
    </div>

    <div class="big-numbers">
      <div class="wind-speed-display" id="windSpd">‚Äî</div>
      <div class="wind-unit">KNOTS</div>
      <div class="wind-dir-text" id="windDir">‚Äî</div>
      <div class="wind-deg" id="windDeg">‚Äî¬∞</div>
    </div>

    <div class="gust-row">
      <div class="mini-stat">
        <div class="mini-stat-label">Gust</div>
        <div class="mini-stat-value" id="gustVal">‚Äî</div>
      </div>
      <div class="mini-stat">
        <div class="mini-stat-label">Temp</div>
        <div class="mini-stat-value blue" id="tempVal">‚Äî</div>
      </div>
      <div class="mini-stat">
        <div class="mini-stat-label">RH%</div>
        <div class="mini-stat-value green" id="rhVal">‚Äî</div>
      </div>
    </div>

    <div class="race-meter" style="width:100%;margin-top:16px;">
      <div class="meter-label">MUI Condition Score</div>
      <div class="meter-score" id="raceScore">‚Äî</div>
      <div class="meter-description" id="raceDesc">Loading conditions...</div>
      <div class="meter-bar-wrap" style="margin-top:10px;">
        <div class="meter-bar" id="raceMeter" style="width:0%"></div>
      </div>
      <div class="meter-scale">
        <span>CALM</span><span>GOOD</span><span>STRONG</span>
      </div>
    </div>
  </div>

  <!-- TREND CHART -->
  <div class="trend-panel">
    <div class="panel-header">
      <div class="section-label" style="margin-bottom:0">Wind History</div>
      <div class="tab-group">
        <button class="tab active" onclick="setChartMode('speed',this)">SPEED</button>
        <button class="tab" onclick="setChartMode('direction',this)">DIRECTION</button>
        <button class="tab" onclick="setChartMode('both',this)">BOTH</button>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="windChart"></canvas>
    </div>
    <div class="sparkline-label" id="chartCaption">Last 18 hours ¬∑ Harrison-Dever Crib</div>
  </div>

  <!-- BOTTOM ROW -->
  <div class="bottom-grid">

    <!-- FORECAST -->
    <div class="forecast-panel">
      <div class="section-label">Hourly Forecast</div>
      <div id="forecastList">
        <div class="loading-shimmer" style="margin-bottom:10px;height:48px;border-radius:8px;"></div>
        <div class="loading-shimmer" style="margin-bottom:10px;height:48px;border-radius:8px;"></div>
        <div class="loading-shimmer" style="height:48px;border-radius:8px;"></div>
      </div>
    </div>

    <!-- TREND ANALYSIS -->
    <div class="analysis-panel">
      <div class="section-label">Trend Analysis</div>
      <div id="trendAnalysis">
        <div class="loading-shimmer" style="height:60px;border-radius:8px;margin-bottom:10px;"></div>
        <div class="loading-shimmer" style="height:60px;border-radius:8px;"></div>
      </div>

      <div class="divider"></div>

      <div class="section-label">18-Hr Sparkline ‚Äî Speed (kts)</div>
      <div class="history-row" id="histBars">
        <!-- Generated dynamically -->
      </div>
      <div class="sparkline-label">‚Üê 18h ago ¬∑¬∑¬∑ now ‚Üí</div>
    </div>

    <!-- LOCAL KNOWLEDGE -->
    <div class="local-panel">
      <div class="section-label" style="margin-bottom:12px">Local Knowledge üèÜ</div>

      <!-- Month badge -->
      <div id="monthBadge" style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <div id="monthPill" style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;padding:4px 14px;border-radius:20px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.25);color:var(--accent);letter-spacing:0.06em;">‚Äî</div>
        <div id="monthTagline" style="font-size:11px;color:var(--muted);line-height:1.4;">Loading seasonal profile...</div>
      </div>

      <!-- Seasonal dynamic tips ‚Äî rendered by JS -->
      <div id="seasonalTips"></div>

      <div id="dynamicTip" class="tip-card" data-icon="üì°" style="border-color:rgba(0,212,255,0.3);margin-top:8px;">
        <div class="tip-condition" style="color:var(--accent)">Current Conditions Note</div>
        <div class="tip-text" id="dynamicTipText">Loading analysis...</div>
      </div>
    </div>

  </div>

  <!-- RAW DATA FEED -->
  <div id="seasonalPanel" class="data-feed" style="border-color:rgba(57,255,140,0.2);">
    <div class="feed-header">
      <div>
        <div class="section-label" style="margin-bottom:4px">
          üåä Seasonal Profile
          <span id="seasonMonthBadge" class="inline-badge" style="background:rgba(57,255,140,0.1);color:var(--accent3);border-color:rgba(57,255,140,0.3);">‚Äî</span>
        </div>
        <div class="source-tag">Lake Michigan ¬∑ Harrison-Dever Crib ¬∑ 2000‚Äì2025 historical patterns</div>
      </div>
      <div id="waterTempBadge" style="text-align:right;">
        <div style="font-size:10px;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px;">Est. Water Temp</div>
        <div id="waterTempVal" style="font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:#00d4ff;">‚Äî</div>
        <div id="waterTempSrc" style="font-size:9px;color:var(--muted2);">historical climatology</div>
      </div>
    </div>

    <!-- Monthly calendar strip -->
    <div id="monthStrip" style="display:flex;gap:6px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px;"></div>

    <!-- Seasonal stats grid -->
    <div id="seasonStatsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:20px;"></div>

    <!-- Seasonal narrative -->
    <div id="seasonNarrative" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px 18px;">
      <div style="font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Month at a Glance</div>
      <div id="seasonNarrativeText" style="font-size:12px;line-height:1.9;color:var(--text);"></div>
    </div>

    <!-- Lake breeze probability chart by hour -->
    <div style="margin-top:16px;">
      <div style="font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Lake Breeze Probability by Hour (this month)</div>
      <div id="lbProbBar" style="display:flex;gap:3px;align-items:flex-end;height:56px;"></div>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px;">
        <span>6am</span><span>9am</span><span>12pm</span><span>3pm</span><span>6pm</span><span>9pm</span>
      </div>
    </div>

    <!-- Confidence modifier note -->
    <div id="seasonConfNote" style="margin-top:14px;padding:10px 14px;background:rgba(57,255,140,0.04);border:1px solid rgba(57,255,140,0.15);border-radius:6px;font-size:11px;color:var(--muted);line-height:1.7;"></div>
  </div>

  <!-- RAW DATA FEED -->
  <div class="data-feed">
    <div class="feed-header">
      <div>
        <div class="section-label" style="margin-bottom:4px">Live NOAA Data Feed
          <span class="inline-badge">CHII2</span>
        </div>
        <div class="source-tag">Harrison-Dever Crib ¬∑ glerl.noaa.gov ¬∑ 2-min resolution</div>
      </div>
      <div class="source-tag" style="text-align:right">
        NDBC Station CHII2<br>41¬∞54'58"N 87¬∞34'22"W<br>2.75 mi offshore ¬∑ racing 1 mi east
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table class="feed-table">
        <thead>
          <tr>
            <th>CST Time</th>
            <th>Wind Dir</th>
            <th>Speed (kts)</th>
            <th>Gust (kts)</th>
            <th>Temp (¬∞F)</th>
            <th>Change</th>
          </tr>
        </thead>
        <tbody id="feedBody">
          <tr><td colspan="6"><div class="loading-shimmer"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 1-HOUR WIND PREDICTION ENGINE -->
  <div class="prediction-panel" id="predPanel">
    <div class="pred-header">
      <div class="pred-title-block">
        <div class="pred-title">‚ö° 60-Minute Wind Prediction</div>
        <div class="pred-subtitle">Multi-signal ensemble ¬∑ Harrison-Dever Crib ¬∑ Lake Michigan</div>
      </div>
      <div class="pred-timestamp" id="predTimestamp">‚Äî</div>
    </div>

    <!-- Horizon tabs -->
    <div class="horizon-tabs">
      <div class="horizon-tab primary">‚ñ∂ +30 min ¬∑ Race Start Window</div>
      <div class="horizon-tab secondary">+60 min ¬∑ Race Planning</div>
    </div>

    <!-- 30-MINUTE PRIMARY CARDS -->
    <div class="horizon-section-label">30-minute prediction ‚Äî higher confidence</div>
    <div class="pred-30-row">
      <div class="pred-30-card">
        <div class="pred-30-label">Speed +30 min</div>
        <div class="pred-30-value" id="pred30Spd" style="color:var(--accent)">‚Äî</div>
        <div class="pred-30-unit">KNOTS</div>
        <div class="pred-30-delta" id="pred30SpdDelta">‚Äî</div>
      </div>
      <div class="pred-30-card">
        <div class="pred-30-label">Direction +30 min</div>
        <div class="pred-30-value" id="pred30DirArrow" style="font-size:28px;">‚Äî</div>
        <div class="pred-30-unit" id="pred30Dir">‚Äî</div>
        <div class="pred-30-delta" id="pred30DirDelta">‚Äî</div>
      </div>
      <div class="pred-30-card">
        <div class="pred-30-label">Gust +30 min</div>
        <div class="pred-30-value" id="pred30Gust" style="color:var(--warn)">‚Äî</div>
        <div class="pred-30-unit">KNOTS</div>
        <div class="pred-30-delta" id="pred30GustDelta">‚Äî</div>
      </div>
    </div>
    <div class="conf-improvement" id="confImprovementNote"></div>

    <!-- 60-MINUTE SECONDARY CARDS -->
    <div class="pred-60-divider">60-minute outlook ¬∑ lower confidence</div>

    <!-- Main prediction cards -->
    <div class="pred-main-row">
      <div class="pred-card">
        <div class="pred-card-label">Predicted Speed (+60 min)</div>
        <div class="pred-card-value" id="predSpd" style="color:var(--accent)">‚Äî</div>
        <div class="pred-card-unit">KNOTS</div>
        <div class="pred-card-delta" id="predSpdDelta">‚Äî</div>
      </div>

      <div class="pred-card">
        <div class="pred-card-label">Predicted Direction (+60 min)</div>
        <div class="pred-dir-arrow" id="predDirArrow">‚Äî</div>
        <div class="pred-card-value" id="predDir" style="color:var(--accent3);font-size:22px;margin-top:4px;">‚Äî</div>
        <div class="pred-card-unit" id="predDirDeg">‚Äî¬∞</div>
        <div class="pred-card-delta" id="predDirDelta">‚Äî</div>
      </div>

      <div class="pred-card">
        <div class="pred-card-label">Predicted Peak Gust (+60 min)</div>
        <div class="pred-card-value" id="predGust" style="color:var(--warn)">‚Äî</div>
        <div class="pred-card-unit">KNOTS</div>
        <div class="pred-card-delta" id="predGustDelta">‚Äî</div>
      </div>

      <div class="pred-card conf-card">
        <div class="pred-card-label" style="text-align:center">Prediction Confidence</div>
        <div class="conf-ring-wrap">
          <svg viewBox="0 0 100 100" style="transform:rotate(-90deg)">
            <circle cx="50" cy="50" r="42" fill="none" stroke="#1e3050" stroke-width="8"/>
            <circle id="confArc" cx="50" cy="50" r="42" fill="none"
              stroke="#00d4ff" stroke-width="8"
              stroke-dasharray="264" stroke-dashoffset="264"
              stroke-linecap="round"
              style="transition: stroke-dashoffset 1.2s cubic-bezier(.4,0,.2,1), stroke 0.5s;"/>
          </svg>
          <div class="conf-center-text">
            <div class="conf-pct" id="confPct" style="color:var(--accent)">‚Äî</div>
            <div class="conf-label">CONF</div>
          </div>
        </div>
        <div class="conf-level-text" id="confLevel">‚Äî</div>
      </div>
    </div>

    <!-- Signal breakdown -->
    <div class="pred-signals">
      <div class="pred-signals-title">Signal Breakdown ‚Äî Why this prediction?</div>
      <div class="signal-grid" id="signalGrid">
        <div class="loading-shimmer" style="height:70px;border-radius:8px;"></div>
        <div class="loading-shimmer" style="height:70px;border-radius:8px;"></div>
        <div class="loading-shimmer" style="height:70px;border-radius:8px;"></div>
        <div class="loading-shimmer" style="height:70px;border-radius:8px;"></div>
      </div>

      <div class="method-chips">
        <span class="method-chip active" id="chip-linreg">Linear Regression</span>
        <span class="method-chip active" id="chip-ewma">EWMA Smoothing</span>
        <span class="method-chip active" id="chip-accel">Acceleration Signal</span>
        <span class="method-chip active" id="chip-veer">Veer/Back Rate</span>
        <span class="method-chip active" id="chip-gust">Gust Ratio Model</span>
        <span class="method-chip active" id="chip-localknow">Chicago Local Knowledge</span>
        <span class="method-chip" id="chip-nws">NWS Marine Forecast</span>
        <span class="method-chip" id="chip-archive">Archive Pattern Match</span>
      </div>

      <div class="disclaimer-bar">
        <strong>‚ö† Prediction Methodology:</strong>
        Ensemble of 7 signals: linear regression (60-obs), EWMA trend, acceleration, circular direction regression, gust ratio, Chicago local knowledge, and Open-Meteo GFS model (+1h, 20% weight).
        NWS NSH marine forecast (LMZ740‚Äì742) displayed separately for human-forecast context.
        Confidence degrades with high gust variability, direction oscillation, and light air.
        Seasonal modifier applied based on month. For authoritative safety forecasts always check
        <strong style="color:var(--accent)">NWS Chicago marine</strong> directly.
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- STATION NETWORK PANEL                          -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="station-network-panel">
    <div class="station-network-header">
      <div>
        <div class="station-network-title">üì° Station Network</div>
        <div class="station-network-subtitle">Live observations ‚Äî upstream stations + on-course</div>
      </div>
      <div id="stationNetworkUpdated" style="font-size:10px;color:var(--muted2);"></div>
    </div>

    <div class="station-grid">
      <!-- CNII2 ‚Äî Northerly Island (on course) -->
      <div class="station-card on-course loading" id="stCard-CNII2">
        <div class="station-card-header">
          <div class="station-id">CNII2</div>
          <div class="station-role">ON COURSE</div>
        </div>
        <div class="station-name">Northerly Island</div>
        <div class="station-wind-row">
          <div class="station-wind-arrow" id="stArrow-CNII2">‚Äî</div>
          <div class="station-wind-spd" id="stSpd-CNII2">‚Äî</div>
          <div class="station-wind-unit">KTS</div>
        </div>
        <div class="station-wind-dir" id="stDir-CNII2">‚Äî</div>
        <div class="station-gust" id="stGust-CNII2"></div>
        <div class="station-temp" id="stTemp-CNII2"></div>
        <div class="station-delta" id="stDelta-CNII2"></div>
      </div>

      <!-- KORD ‚Äî O'Hare -->
      <div class="station-card upstream loading" id="stCard-KORD">
        <div class="station-card-header">
          <div class="station-id">KORD</div>
          <div class="station-role">UPSTREAM W</div>
        </div>
        <div class="station-name">O'Hare International</div>
        <div class="station-wind-row">
          <div class="station-wind-arrow" id="stArrow-KORD">‚Äî</div>
          <div class="station-wind-spd" id="stSpd-KORD">‚Äî</div>
          <div class="station-wind-unit">KTS</div>
        </div>
        <div class="station-wind-dir" id="stDir-KORD">‚Äî</div>
        <div class="station-gust" id="stGust-KORD"></div>
        <div class="station-temp" id="stTemp-KORD"></div>
        <div class="station-delta" id="stDelta-KORD"></div>
      </div>

      <!-- KMDW ‚Äî Midway -->
      <div class="station-card upstream loading" id="stCard-KMDW">
        <div class="station-card-header">
          <div class="station-id">KMDW</div>
          <div class="station-role">UPSTREAM SW</div>
        </div>
        <div class="station-name">Midway Airport</div>
        <div class="station-wind-row">
          <div class="station-wind-arrow" id="stArrow-KMDW">‚Äî</div>
          <div class="station-wind-spd" id="stSpd-KMDW">‚Äî</div>
          <div class="station-wind-unit">KTS</div>
        </div>
        <div class="station-wind-dir" id="stDir-KMDW">‚Äî</div>
        <div class="station-gust" id="stGust-KMDW"></div>
        <div class="station-temp" id="stTemp-KMDW"></div>
        <div class="station-delta" id="stDelta-KMDW"></div>
      </div>

      <!-- KGYY ‚Äî Gary -->
      <div class="station-card upstream loading" id="stCard-KGYY">
        <div class="station-card-header">
          <div class="station-id">KGYY</div>
          <div class="station-role">UPSTREAM S</div>
        </div>
        <div class="station-name">Gary Chicago Intl</div>
        <div class="station-wind-row">
          <div class="station-wind-arrow" id="stArrow-KGYY">‚Äî</div>
          <div class="station-wind-spd" id="stSpd-KGYY">‚Äî</div>
          <div class="station-wind-unit">KTS</div>
        </div>
        <div class="station-wind-dir" id="stDir-KGYY">‚Äî</div>
        <div class="station-gust" id="stGust-KGYY"></div>
        <div class="station-temp" id="stTemp-KGYY"></div>
        <div class="station-delta" id="stDelta-KGYY"></div>
      </div>
    </div>

    <!-- Lake breeze thermal meter -->
    <div class="lb-meter-row">
      <div class="lb-meter-label">Lake Breeze Index</div>
      <div class="lb-meter-bar-wrap">
        <div class="lb-meter-bar" id="lbIndexBar" style="width:0%"></div>
      </div>
      <div class="lb-meter-val" id="lbIndexVal">‚Äî</div>
    </div>
    <div class="lb-meter-note" id="lbIndexNote">Loading station data‚Ä¶</div>
  </div>

  <!-- MARINE FORECAST PANELS                         -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="marine-grid">

    <!-- NWS NEARSHORE FORECAST -->
    <div class="marine-panel nws">
      <div class="marine-header">
        <div>
          <div class="marine-title">üì° NWS Nearshore Marine Forecast</div>
          <div class="marine-issued" id="nwsIssued">LMZ740‚Äì742 ¬∑ Wilmette to Calumet ¬∑ within 5 nm</div>
        </div>
        <span class="marine-status status-load" id="nwsStatus">LOADING</span>
      </div>
      <div id="nwsPeriods">
        <div class="loading-shimmer" style="height:48px;border-radius:8px;margin-bottom:8px;"></div>
        <div class="loading-shimmer" style="height:48px;border-radius:8px;margin-bottom:8px;"></div>
        <div class="loading-shimmer" style="height:48px;border-radius:8px;"></div>
      </div>
      <div id="nwsShiftAlert" style="display:none;" class="nws-shift-alert"></div>
    </div>

    <!-- OPEN-METEO MODEL FORECAST -->
    <div class="marine-panel meteo">
      <div class="marine-header">
        <div>
          <div class="marine-title">üåê HRRR + GFS Model Forecast</div>
          <div class="marine-issued">41.916¬∞N 87.573¬∞W ¬∑ HRRR 3km primary ¬∑ GFS 13km fallback ¬∑ 15-min res ¬∑ race course cell</div>
        </div>
        <span class="marine-status status-load" id="meteoStatus">LOADING</span>
      </div>
      <div id="meteoPeriods">
        <div class="loading-shimmer" style="height:200px;border-radius:8px;"></div>
      </div>
      <div id="modelSpreadBadge" style="display:none;margin-top:10px;padding:8px 12px;border-radius:6px;font-size:11px;line-height:1.6;"></div>
      <div class="meteo-blend-note" id="meteoBlendNote" style="display:none;"></div>
    </div>

  </div>

  <!-- MOBILE / iOS NOTICE -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- RACE STRATEGY PANEL                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="strategy-panel" id="strategyPanel" style="display:none;">
    <div class="strategy-header">
      <div>
        <div class="strategy-title">‚õµ Race Strategy Brief</div>
        <div class="strategy-meta" id="strategyMeta">Windward-leeward one-design ¬∑ Chicago lakefront ¬∑ Updated on data load</div>
      </div>
      <div class="strategy-confidence">
        <div class="strategy-conf-pip" id="strategyConfPip"></div>
        <span id="strategyConfLabel"></span>
      </div>
    </div>

    <!-- Safety / advisory alert -->
    <div class="strategy-alert danger" id="strategyDangerAlert"></div>
    <div class="strategy-alert warn"   id="strategyWarnAlert"></div>

    <!-- Side call -->
    <div class="side-call" id="strategySideCall"></div>

    <!-- Tactic sections grid -->
    <div class="strategy-sections">
      <div class="strategy-section">
        <div class="strategy-section-title">üèÅ Start Line</div>
        <ul class="strategy-bullets" id="strategyStart"></ul>
      </div>
      <div class="strategy-section">
        <div class="strategy-section-title">‚¨Ü Upwind Leg</div>
        <ul class="strategy-bullets" id="strategyUpwind"></ul>
      </div>
      <div class="strategy-section">
        <div class="strategy-section-title">‚¨á Downwind Leg</div>
        <ul class="strategy-bullets" id="strategyDownwind"></ul>
      </div>
      <div class="strategy-section">
        <div class="strategy-section-title">üëÅ Watch For</div>
        <ul class="strategy-bullets" id="strategyWatch"></ul>
      </div>
    </div>

    <!-- Full narrative -->
    <div class="strategy-narrative" id="strategyNarrative"></div>
  </div>

  <!-- MOBILE / iOS NOTICE (original) -->
  <div class="mobile-notice">
    <div class="notice-icon">üì±</div>
    <div class="notice-content">
      <h3>iOS / Mobile Setup Guide</h3>
      <p>This dashboard works as a mobile web app. For real-time phone updates, here are the recommended options ‚Äî from quickest to most powerful:</p>
      <div class="code-block">
        <span>Option 1 (Instant ‚Äî No Code):</span><br>
        Open this page in Safari ‚Üí Share ‚Üí "Add to Home Screen"<br>
        Set a reminder to refresh before races. Works offline-cached.<br><br>
        <span>Option 2 (Automations):</span><br>
        iOS Shortcuts: Fetch https://www.glerl.noaa.gov/metdata/chi/<br>
        Parse current conditions ‚Üí push notification. Run every 15 min.<br><br>
        <span>Option 3 (Full App ‚Äî Backend Required):</span><br>
        Python FastAPI backend ‚Üí polls GLERL every 2 min<br>
        Sends APNs push via Firebase Cloud Messaging (free tier)<br>
        Alert triggers: wind shift &gt;25¬∞, speed change &gt;3kts in 10min<br><br>
        <span>Data URLs to poll:</span><br>
        Real-time: glerl.noaa.gov/metdata/chi/[YYYY]/[YYYYMMDD].04t.txt<br>
        Archive:   glerl.noaa.gov/metdata/chi/archive/chi[YYYY].04t.txt<br>
        NDBC API:  api.tidesandcurrents.noaa.gov/api/prod/datagetter?station=CHII2
      </div>
    </div>
  </div>

</div><!-- end main-grid -->
</div><!-- end app -->

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let chartInstance = null;
let chartMode = 'speed';
let parsedData = [];
let lastDir = null;
let lastSpd = null;

// Bearing to compass label
function degToCompass(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}

// m/s to knots
function ms2kts(v) { return (parseFloat(v) * 1.94384).toFixed(1); }

// Parse raw GLERL txt line
function parseLine(line) {
  const parts = line.trim().split(/\s+/);
  if (parts.length < 8 || parts[0] !== '4') return null;
  const year = parseInt(parts[1]);
  const doy  = parseInt(parts[2]);
  const utc  = parts[3];
  const airC = parseFloat(parts[4]);
  const spdMs= parseFloat(parts[5]);
  const gstMs= parseFloat(parts[6]);
  const dir  = parseFloat(parts[7]);
  const rh   = parseFloat(parts[8]) || null;

  const h = parseInt(utc.substring(0,2));
  const m = parseInt(utc.substring(2,4));
  // Build a real Date from the DOY/UTC fields so Intl handles CST/CDT automatically
  const obsDate = new Date(Date.UTC(year, 0, doy, h, m));
  const fmt = new Intl.DateTimeFormat('en-US', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Chicago' });
  const timeLabel = fmt.format(obsDate).replace(/^24:/, '00:'); // Intl quirk: midnight = '24:00'

  const airF = (airC * 9/5 + 32).toFixed(1);
  const spdKts = parseFloat(ms2kts(spdMs));
  const gstKts = parseFloat(ms2kts(gstMs));

  return { year, doy, utc, timeLabel, airC, airF, spdKts, gstKts, dir, rh };
}

// Build the URL for today's data
// Build the URL for today's data
function getTodayUrl() {
  return 'https://glerl-proxy.edward-k-mui.workers.dev/';
}

function getYesterdayUrl() {
  const now = new Date();
  const yest = new Date(now);
  yest.setUTCDate(yest.getUTCDate() - 1);
  const y  = yest.getUTCFullYear();
  const mm = String(yest.getUTCMonth() + 1).padStart(2, '0');
  const dd = String(yest.getUTCDate()).padStart(2, '0');
  return `https://glerl-proxy.edward-k-mui.workers.dev/?date=${y}${mm}${dd}`;
}

// Timeout helper ‚Äî abort fetch after N seconds
function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), timeoutMs);
  return fetch(url, { ...options, signal: controller.signal })
    .finally(() => clearTimeout(timeout));
}

async function fetchGLERL() {
  // Fetch today and yesterday in parallel, merge, dedupe, sort
  const [todayResp, yestResp] = await Promise.allSettled([
    fetchWithTimeout(getTodayUrl(), { cache: 'no-store' }, 10000),
    fetchWithTimeout(getYesterdayUrl(), { cache: 'no-store' }, 10000)
  ]);

  const parseResp = async (result) => {
    if (result.status !== 'fulfilled' || !result.value.ok) return [];
    const text = await result.value.text();
    const lines = text.split('\n').filter(l => l.trim().startsWith('4'));
    return lines.map(parseLine).filter(Boolean);
  };

  const [todayData, yestData] = await Promise.all([
    parseResp(todayResp),
    parseResp(yestResp)
  ]);

  // Merge, dedupe by timestamp, sort ascending
  const all = [...yestData, ...todayData];
  const seen = new Set();
  const deduped = all.filter(d => {
    const key = `${d.year}-${d.doy}-${d.utc}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  // Sort by actual UTC time
  deduped.sort((a, b) => {
    const ta = Date.UTC(a.year, 0, a.doy, parseInt(a.utc.substring(0,2)), parseInt(a.utc.substring(2,4)));
    const tb = Date.UTC(b.year, 0, b.doy, parseInt(b.utc.substring(0,2)), parseInt(b.utc.substring(2,4)));
    return ta - tb;
  });

  return deduped;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function setLiveStatus(state) {
  const dot = document.getElementById('liveDot');
  const label = document.getElementById('liveLabel');
  dot.className = 'dot ' + (state === 'live' ? '' : state);
  label.textContent = state === 'live' ? 'LIVE' : state === 'loading' ? 'LOADING...' : 'ERROR';
}

function renderHero(d) {
  // Compass arrow: arrow points toward wind source (FROM convention ‚Äî standard met/sailing)
  // NOAA "dir" = degrees FROM which wind comes; arrow points back toward that source
  const arrowDeg = d.dir;
  document.getElementById('arrowWrap').style.transform = `rotate(${arrowDeg}deg)`;

  document.getElementById('windSpd').textContent = d.spdKts.toFixed(1);
  document.getElementById('windDir').textContent = degToCompass(d.dir);
  document.getElementById('windDeg').textContent = `${Math.round(d.dir)}¬∞`;
  document.getElementById('gustVal').textContent = d.gstKts.toFixed(1);
  document.getElementById('tempVal').textContent = `${d.airF}¬∞F`;
  document.getElementById('rhVal').textContent = d.rh ? `${Math.round(d.rh)}%` : '‚Äî';

  // Race condition score
  const s = raceScore(d.spdKts, d.gstKts, d.dir);
  const scoreEl = document.getElementById('raceScore');
  scoreEl.textContent = s.score;
  scoreEl.className = 'meter-score ' + s.cls;
  document.getElementById('raceDesc').textContent = s.label;
  const pct = Math.min(100, (d.spdKts / 25) * 100);
  const meterEl = document.getElementById('raceMeter');
  meterEl.style.width = pct + '%';
  meterEl.style.backgroundPosition = pct + '% 0%';
}

function raceScore(kts, gst, dir) {
  // Simple heuristic for Lake Michigan racing
  let score = 0;
  // Best wind: 8‚Äì18 kts, consistent (gust ratio low), direction not from S (shifty)
  if (kts >= 6 && kts <= 20) score += 40;
  else if (kts >= 4) score += 20;
  const gustRatio = gst / Math.max(kts, 1);
  if (gustRatio < 1.25) score += 30;
  else if (gustRatio < 1.5) score += 15;
  const dirLabel = degToCompass(dir);
  if (['W','NW','WNW','NNW','SW','WSW'].includes(dirLabel)) score += 30;
  else if (['N','NE','NNE'].includes(dirLabel)) score += 20;
  else score += 10;

  if (score >= 80) return { score, label: 'Excellent racing conditions', cls: 'score-excellent' };
  if (score >= 60) return { score, label: 'Good racing conditions', cls: 'score-good' };
  if (score >= 35) return { score, label: 'Fair ‚Äî some variability', cls: 'score-fair' };
  return { score, label: 'Challenging ‚Äî light or variable', cls: 'score-rough' };
}

function renderChart(data) {
  if (!data.length) return;

  // Slice last 18 hours of raw data first, THEN sample for readability
  const nowMs = Date.now();
  const cutoff = nowMs - (18 * 60 * 60 * 1000);
  const last18hrs = data.filter(d => {
    const t = Date.UTC(d.year, 0, d.doy, parseInt(d.utc.substring(0,2)), parseInt(d.utc.substring(2,4)));
    return t >= cutoff;
  });

  // Sample every 30th point for readability (keep at most ~36 points)
  const sampled = [];
  for (let i = 0; i < last18hrs.length; i += 30) sampled.push(last18hrs[i]);
  // Always include the very last obs so chart reaches current time
  const lastObs = last18hrs[last18hrs.length - 1];
  if (sampled.length && sampled[sampled.length - 1] !== lastObs) sampled.push(lastObs);

  const recent = sampled;
  const labels = recent.map(d => d.timeLabel);
  const speeds = recent.map(d => d.spdKts);
  const gusts  = recent.map(d => d.gstKts);
  const dirs   = recent.map(d => d.dir);

  const ctx = document.getElementById('windChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();

  const datasets = [];

  if (chartMode === 'speed' || chartMode === 'both') {
    datasets.push({
      label: 'Wind Speed (kts)',
      data: speeds,
      borderColor: '#00d4ff',
      backgroundColor: 'rgba(0,212,255,0.08)',
      borderWidth: 2,
      pointRadius: 3,
      pointBackgroundColor: '#00d4ff',
      tension: 0.4,
      fill: true,
      yAxisID: 'y'
    });
    datasets.push({
      label: 'Gust (kts)',
      data: gusts,
      borderColor: '#ff6b35',
      backgroundColor: 'transparent',
      borderWidth: 1.5,
      borderDash: [4, 3],
      pointRadius: 2,
      tension: 0.4,
      yAxisID: 'y'
    });
  }

  if (chartMode === 'direction' || chartMode === 'both') {
    datasets.push({
      label: 'Wind Dir (¬∞)',
      data: dirs,
      borderColor: '#39ff8c',
      backgroundColor: 'transparent',
      borderWidth: 2,
      pointRadius: 2,
      tension: 0.3,
      yAxisID: chartMode === 'both' ? 'y2' : 'y'
    });
  }

  const scales = {
    x: {
      ticks: { color: '#5a7a9a', font: { family: 'DM Mono', size: 10 }, maxTicksLimit: 9 },
      grid: { color: 'rgba(30,48,80,0.5)' }
    },
    y: {
      ticks: { color: '#5a7a9a', font: { family: 'DM Mono', size: 10 } },
      grid: { color: 'rgba(30,48,80,0.5)' },
      title: { display: true, text: chartMode === 'direction' ? 'Direction (¬∞)' : 'Speed (kts)', color: '#5a7a9a', font: { size: 10, family: 'DM Mono' } }
    }
  };

  if (chartMode === 'both') {
    scales.y2 = {
      position: 'right',
      ticks: { color: '#39ff8c', font: { family: 'DM Mono', size: 10 } },
      grid: { drawOnChartArea: false },
      title: { display: true, text: 'Dir (¬∞)', color: '#39ff8c', font: { size: 10, family: 'DM Mono' } }
    };
  }

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 600 },
      plugins: {
        legend: { labels: { color: '#5a7a9a', font: { family: 'DM Mono', size: 10 }, boxWidth: 16 } },
        tooltip: {
          backgroundColor: '#0d1622',
          borderColor: '#1e3050',
          borderWidth: 1,
          titleColor: '#e8f4ff',
          bodyColor: '#5a7a9a',
          titleFont: { family: 'Syne', size: 13 },
          bodyFont: { family: 'DM Mono', size: 11 }
        }
      },
      scales
    }
  });
}

function renderFeed(data) {
  const body = document.getElementById('feedBody');
  const recent = data.slice(-15).reverse();
  body.innerHTML = recent.map((d, i) => {
    const prev = recent[i+1];
    let changeHtml = '<span class="change-same">‚Äî</span>';
    if (prev) {
      const diff = d.spdKts - prev.spdKts;
      if (Math.abs(diff) > 0.3) {
        const cls = diff > 0 ? 'change-up' : 'change-down';
        const arrow = diff > 0 ? '‚Üë' : '‚Üì';
        changeHtml = `<span class="${cls}">${arrow} ${Math.abs(diff).toFixed(1)} kts</span>`;
      }
    }
    const arrow = dirArrow(d.dir);
    return `<tr>
      <td>${d.timeLabel} CST</td>
      <td><span class="dir-chip"><span class="dir-mini-arrow">${arrow}</span> ${degToCompass(d.dir)} ${Math.round(d.dir)}¬∞</span></td>
      <td><strong style="color:var(--accent)">${d.spdKts}</strong></td>
      <td style="color:var(--warn)">${d.gstKts}</td>
      <td>${d.airF}¬∞F</td>
      <td>${changeHtml}</td>
    </tr>`;
  }).join('');
}

function dirArrow(deg) {
  const arrows = ['‚Üì','‚Üô','‚Üê','‚Üñ','‚Üë','‚Üó','‚Üí','‚Üò'];
  return arrows[Math.round(deg / 45) % 8];
}

function renderForecast(data) {
  // Use last few hours to extrapolate + add a note
  // In production: fetch from NWS/Open-Meteo marine API
  const recent = data.slice(-6);
  if (!recent.length) return;

  const avgSpd = recent.reduce((s,d) => s + d.spdKts, 0) / recent.length;
  const avgDir = recent.reduce((s,d) => s + d.dir, 0) / recent.length;
  const trend = recent[recent.length-1].spdKts - recent[0].spdKts;

  const items = [];
  const now = new Date();
  for (let h = 1; h <= 6; h++) {
    const hr = new Date(now.getTime() + h * 3600000);
    const label = `+${h}h`;
    const projSpd = Math.max(3, avgSpd + trend * h * 0.3);
    const projDir = (avgDir + h * 5) % 360;
    const g = projSpd * 1.25;

    let badge, badgeCls;
    if (projSpd >= 8 && projSpd <= 18) { badge = 'GOOD'; badgeCls = 'badge-good'; }
    else if (projSpd > 18) { badge = 'STRONG'; badgeCls = 'badge-strong'; }
    else { badge = 'LIGHT'; badgeCls = 'badge-ok'; }

    items.push(`
      <div class="forecast-item">
        <div class="forecast-time">${label}</div>
        <div class="forecast-arrow">${dirArrow(projDir)}</div>
        <div class="forecast-data">
          <div class="forecast-spd">${projSpd.toFixed(1)} <span style="font-size:12px;color:var(--muted)">kts</span></div>
          <div class="forecast-dir">${degToCompass(projDir)} ¬∑ ${Math.round(projDir)}¬∞ ¬∑ Gust ~${g.toFixed(0)} kts</div>
        </div>
        <span class="forecast-badge ${badgeCls}">${badge}</span>
      </div>
    `);
  }

  document.getElementById('forecastList').innerHTML = items.join('') +
    `<div style="margin-top:10px;font-size:10px;color:var(--muted2);line-height:1.6;">
      ‚ö† Short-range extrapolation from NOAA GLERL data.<br>
      For NWS marine forecasts: <span style="color:var(--accent)">weather.gov/lmk</span>
    </div>`;
}

function renderAnalysis(data) {
  if (data.length < 10) return;
  const hourCST = parseInt(new Intl.DateTimeFormat('en-US',{hour:'numeric',hour12:false,timeZone:'America/Chicago'}).format(new Date())) % 24;
  const recent = data.slice(-30); // last hour (30 √ó 2min)
  const first = recent[0];
  const last = recent[recent.length - 1];

  const spdDiff = last.spdKts - first.spdKts;
  const dirDiff = ((last.dir - first.dir + 540) % 360) - 180;

  const indicators = [];

  // Speed trend
  if (Math.abs(spdDiff) > 2) {
    const up = spdDiff > 0;
    indicators.push(`
      <div class="trend-indicator ${up ? 'danger' : 'good'}">
        <div class="trend-icon">${up ? 'üìà' : 'üìâ'}</div>
        <div class="trend-text">
          <strong>Speed ${up ? 'Building' : 'Dropping'}: ${Math.abs(spdDiff).toFixed(1)} kts/hr</strong>
          Wind has ${up ? 'increased' : 'decreased'} from ${first.spdKts.toFixed(1)} ‚Üí ${last.spdKts.toFixed(1)} kts over the last hour.
        </div>
      </div>
    `);
  } else {
    indicators.push(`
      <div class="trend-indicator">
        <div class="trend-icon">‚û°Ô∏è</div>
        <div class="trend-text">
          <strong>Speed Steady</strong>
          Holding ${last.spdKts.toFixed(1)} kts ¬± ${Math.abs(spdDiff).toFixed(1)} kts/hr.
        </div>
      </div>
    `);
  }

  // Direction shift
  if (Math.abs(dirDiff) > 15) {
    const veer = dirDiff > 0;
    indicators.push(`
      <div class="trend-indicator warn">
        <div class="trend-icon">${veer ? '‚Üª' : '‚Ü∫'}</div>
        <div class="trend-text">
          <strong>Direction ${veer ? 'Veering' : 'Backing'} ${Math.abs(dirDiff).toFixed(0)}¬∞</strong>
          ${veer ? 'Clockwise' : 'Counter-clockwise'} shift: ${degToCompass(first.dir)} ‚Üí ${degToCompass(last.dir)}. ${veer ? 'Watch for starboard lift.' : 'Watch for port lift.'}
        </div>
      </div>
    `);
  } else {
    indicators.push(`
      <div class="trend-indicator good">
        <div class="trend-icon">üéØ</div>
        <div class="trend-text">
          <strong>Direction Stable</strong>
          Holding ${degToCompass(last.dir)} with &lt;${Math.abs(dirDiff).toFixed(0)}¬∞ shift last hour.
        </div>
      </div>
    `);
  }

  document.getElementById('trendAnalysis').innerHTML = indicators.join('');

  // Dynamic local tip ‚Äî season-aware
  const tipEl = document.getElementById('dynamicTipText');
  const dir = degToCompass(last.dir);
  const spd = last.spdKts;
  const month = new Date().getMonth();
  const sp = getSeasonalProfile();
  let tip = '';

  // Month-specific overrides first
  if (month === 6 && hourCST >= 11 && hourCST <= 15 && ['S','SW','SSW','SE'].includes(dir) && spd < 12) {
    tip = `July ${hourCST}:00 CST, ${dir} at ${spd.toFixed(0)} kts ‚Äî prime lake breeze window. Watch for the NE fill from the right. Peak probability: ${sp.lakeBreezeProbByHour[hourCST]}% this hour. Position yourself for the right side of the course.`;
  } else if (month === 7 && hourCST >= 14 && hourCST <= 18) {
    tip = `August afternoon: peak squall window. Current ${dir} at ${spd.toFixed(0)} kts. Monitor radar to the W/SW ‚Äî MCS squall lines can bring 35‚Äì55 kt gusts with 10‚Äì15 min warning on Lake Michigan.`;
  } else if (month === 8 && ['W','NW','WNW','NNW'].includes(dir) && spd > 10) {
    tip = `September W/NW at ${spd.toFixed(0)} kts ‚Äî the best racing wind of the year. Post-frontal. Lake breeze season is over; this is pure synoptic gradient. Expect consistency. Starboard tack upwind in WNW.`;
  } else if (month === 4 && ['W','NW','WNW'].includes(dir)) {
    tip = `May W/NW at ${spd.toFixed(0)} kts ‚Äî classic synoptic gradient. Lake at ~${sp.waterTempMid}¬∞F. Cold water stabilizes the column; wind may feel lighter offshore than the Crib reading suggests. Trust the Crib.`;
  } else if (['W','NW','WNW'].includes(dir) && spd > 10) {
    tip = `${dir} at ${spd.toFixed(0)} kts ‚Äî post-frontal classic. Expect steady pressure. Starboard tack favored upwind. Square waves building with fetch. Watch for city wind shadow on the leeward leg near Navy Pier.`;
  } else if (['S','SW','SSW','SSE'].includes(dir)) {
    tip = `${dir} at ${spd.toFixed(0)} kts ‚Äî southerly flow. City thermal creates left-of-mean bias near shore. Wind often holes near Navy Pier. Watch for persistent port shifts on upwind leg. ${month === 7 ? 'August southerlies are the "drifter" ‚Äî pressure lanes offshore are critical.' : ''}`;
  } else if (['N','NE','NNE','ENE'].includes(dir)) {
    tip = `${dir} at ${spd.toFixed(0)} kts ‚Äî lake breeze ${month >= 5 && month <= 7 ? 'likely established' : 'or post-front return flow'}. ${month >= 5 && month <= 7 ? 'Expect oscillating shifts ¬±15‚Äì20¬∞. Never overstand ‚Äî head-up sailing mode.' : 'Typically steady but may ease in afternoon.'}`;
  } else if (spd < 5) {
    tip = `Light air (${spd.toFixed(0)} kts) ‚Äî patience. ${month === 7 ? 'July light air: city thermals and lake gradient create random puffs. Pressure lanes are everything.' : 'Lake thermals and land-sea differential create variable puffs near shore. Sail the lifts.'}`;
  } else {
    tip = `${dir} at ${spd.toFixed(0)} kts in ${sp.name}. ${sp.shiftCharacter}. Est. water temp ~${sp.waterTempMid}¬∞F. Lake breeze probability this hour: ${sp.lakeBreezeProbByHour[hourCST] || 0}%.`;
  }
  tipEl.textContent = tip;

  // Sparkline bars
  const hourly = [];
  for (let i = 0; i < data.length; i += 30) hourly.push(data[i]);
  const recent18 = hourly.slice(-18);
  const maxSpd = Math.max(...recent18.map(d => d.spdKts), 1);
  const barsEl = document.getElementById('histBars');
  barsEl.innerHTML = recent18.map((d, i) => {
    const h = Math.round((d.spdKts / maxSpd) * 100);
    const isLast = i === recent18.length - 1;
    return `<div class="hist-bar ${isLast ? 'active' : ''}" style="height:${h}%" title="${d.timeLabel}: ${d.spdKts} kts ${degToCompass(d.dir)}"></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadData() {
  setLiveStatus('loading');
  try {
    const data = await fetchGLERL();
    parsedData = data;
    if (!data.length) throw new Error('No data rows');

    const latest = data[data.length - 1];
    renderHero(latest);
    renderChart(data);
    renderFeed(data);
    renderForecast(data);
    renderAnalysis(data);
    renderPrediction(data);
    renderSeasonalPanel();

    // Fetch marine forecasts in parallel ‚Äî non-blocking, update when ready
    fetchNWSForecast()
      .then(renderNWSForecast)
      .catch(e => {
        console.warn('NWS fetch failed:', e);
        document.getElementById('nwsStatus').textContent = 'UNAVAILABLE';
        document.getElementById('nwsStatus').className = 'marine-status status-error';
        document.getElementById('nwsPeriods').innerHTML =
          `<div style="color:var(--muted);font-size:12px;">NWS API unavailable. Check <a href="https://forecast.weather.gov/product.php?site=lot&product=nsh&issuedby=lot" target="_blank" style="color:var(--accent)">weather.gov/lot/marine</a> directly.</div>`;
      });

    fetchOpenMeteo()
      .then(raw => {
        renderOpenMeteo(raw);
        // Re-run prediction with model data now available
        renderPrediction(data);
      })
      .catch(e => {
        console.warn('Open-Meteo fetch failed:', e);
        document.getElementById('meteoStatus').textContent = 'UNAVAILABLE';
        document.getElementById('meteoStatus').className = 'marine-status status-error';
        document.getElementById('meteoPeriods').innerHTML =
          `<div style="color:var(--muted);font-size:12px;">Open-Meteo API unavailable. Prediction running on Crib data only.</div>`;
      });

    // Fetch station network ‚Äî non-blocking, re-renders prediction when ready
    fetchStationNetwork()
      .then(stations => {
        renderStationNetwork(stations, data);
        renderPrediction(data);   // re-run with upstream signal now available
      })
      .catch(e => console.warn('Station network fetch failed:', e));

    const now = new Date();
    document.getElementById('updateTime').textContent =
      `Updated ${now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', timeZone:'America/Chicago'})}`;

    setLiveStatus('live');
  } catch (err) {
    console.error(err);
    setLiveStatus('error');
    document.getElementById('updateTime').textContent = 'Failed to load ‚Äî check console';

    // Fallback: use demo data so UI is still functional
    loadDemoData();
  }
}

function loadDemoData() {
  // Demo data based on today's real readings we saw (11am CST 2/15/2026)
  const demo = [
    { timeLabel:'06:00', spdKts:6.0, gstKts:7.6, dir:193, airF:'42.3', rh:70 },
    { timeLabel:'07:00', spdKts:4.3, gstKts:5.1, dir:194, airF:'40.3', rh:70 },
    { timeLabel:'08:00', spdKts:6.6, gstKts:8.0, dir:243, airF:'42.6', rh:68 },
    { timeLabel:'09:00', spdKts:11.3, gstKts:12.6, dir:269, airF:'42.4', rh:76 },
    { timeLabel:'10:00', spdKts:14.6, gstKts:15.7, dir:265, airF:'46.9', rh:73 },
    { timeLabel:'11:00', spdKts:9.7, gstKts:10.5, dir:280, airF:'49.3', rh:71 },
  ];

  const latest = demo[demo.length - 1];
  const arrowDeg = latest.dir;
  document.getElementById('arrowWrap').style.transform = `rotate(${arrowDeg}deg)`;
  document.getElementById('windSpd').textContent = latest.spdKts.toFixed(1);
  document.getElementById('windDir').textContent = degToCompass(latest.dir);
  document.getElementById('windDeg').textContent = `${latest.dir}¬∞`;
  document.getElementById('gustVal').textContent = latest.gstKts.toFixed(1);
  document.getElementById('tempVal').textContent = `${latest.airF}¬∞F`;
  document.getElementById('rhVal').textContent = `${latest.rh}%`;

  const s = raceScore(latest.spdKts, latest.gstKts, latest.dir);
  document.getElementById('raceScore').textContent = s.score;
  document.getElementById('raceScore').className = 'meter-score ' + s.cls;
  document.getElementById('raceDesc').textContent = s.label;
  document.getElementById('raceMeter').style.width = Math.min(100, (latest.spdKts / 25) * 100) + '%';

  // Chart
  const ctx = document.getElementById('windChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: demo.map(d => d.timeLabel),
      datasets: [
        {
          label: 'Wind Speed (kts)',
          data: demo.map(d => d.spdKts),
          borderColor: '#00d4ff', backgroundColor: 'rgba(0,212,255,0.08)',
          borderWidth: 2, pointRadius: 4, tension: 0.4, fill: true
        },
        {
          label: 'Gust (kts)',
          data: demo.map(d => d.gstKts),
          borderColor: '#ff6b35', backgroundColor: 'transparent',
          borderWidth: 1.5, borderDash: [4,3], pointRadius: 2, tension: 0.4
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color:'#5a7a9a', font:{ family:'DM Mono', size:10 }, boxWidth:16 }},
        tooltip: { backgroundColor:'#0d1622', borderColor:'#1e3050', borderWidth:1, titleColor:'#e8f4ff', bodyColor:'#5a7a9a' }
      },
      scales: {
        x: { ticks:{ color:'#5a7a9a', font:{ family:'DM Mono', size:10 }}, grid:{ color:'rgba(30,48,80,0.5)' }},
        y: { ticks:{ color:'#5a7a9a', font:{ family:'DM Mono', size:10 }}, grid:{ color:'rgba(30,48,80,0.5)' }}
      }
    }
  });

  // Feed table
  const body = document.getElementById('feedBody');
  body.innerHTML = demo.slice().reverse().map(d => `
    <tr>
      <td>${d.timeLabel} CST</td>
      <td><span class="dir-chip">${dirArrow(d.dir)} ${degToCompass(d.dir)} ${d.dir}¬∞</span></td>
      <td><strong style="color:var(--accent)">${d.spdKts}</strong></td>
      <td style="color:var(--warn)">${d.gstKts}</td>
      <td>${d.airF}¬∞F</td>
      <td>‚Äî</td>
    </tr>
  `).join('');

  // Trend
  document.getElementById('trendAnalysis').innerHTML = `
    <div class="trend-indicator danger">
      <div class="trend-icon">üìà</div>
      <div class="trend-text"><strong>Speed Built +8.6 kts (06:00‚Üí10:00)</strong>Rapid increase correlated with frontal passage. Wind veered from S to W.</div>
    </div>
    <div class="trend-indicator warn">
      <div class="trend-icon">‚Üª</div>
      <div class="trend-text"><strong>Direction Veering: S‚ÜíW (+87¬∞)</strong>Classic frontal veer over 4 hours. Crib now reading 280¬∞ (W). Starboard tack favored.</div>
    </div>
  `;
  document.getElementById('dynamicTipText').textContent =
    'W/NW at 9.7 kts ‚Äî classic post-frontal Chicago. Expect pressure to hold or build through afternoon. Starboard tack upwind, watch for right shifts.';

  // Bars
  const barsEl = document.getElementById('histBars');
  const maxS = Math.max(...demo.map(d => d.spdKts));
  barsEl.innerHTML = demo.map((d, i) =>
    `<div class="hist-bar ${i===demo.length-1?'active':''}" style="height:${Math.round(d.spdKts/maxS*100)}%"></div>`
  ).join('');

  // Forecast
  document.getElementById('forecastList').innerHTML = [
    {h:'+1h', spd:10.2, dir:282, badge:'GOOD', cls:'badge-good'},
    {h:'+2h', spd:11.8, dir:290, badge:'GOOD', cls:'badge-good'},
    {h:'+3h', spd:12.4, dir:295, badge:'GOOD', cls:'badge-good'},
    {h:'+4h', spd:13.1, dir:298, badge:'GOOD', cls:'badge-good'},
    {h:'+5h', spd:11.6, dir:302, badge:'GOOD', cls:'badge-good'},
    {h:'+6h', spd:9.3,  dir:305, badge:'GOOD', cls:'badge-good'},
  ].map(f => `
    <div class="forecast-item">
      <div class="forecast-time">${f.h}</div>
      <div class="forecast-arrow">${dirArrow(f.dir)}</div>
      <div class="forecast-data">
        <div class="forecast-spd">${f.spd.toFixed(1)} <span style="font-size:12px;color:var(--muted)">kts</span></div>
        <div class="forecast-dir">${degToCompass(f.dir)} ¬∑ ${f.dir}¬∞ ¬∑ Gust ~${(f.spd*1.25).toFixed(0)} kts</div>
      </div>
      <span class="forecast-badge ${f.cls}">${f.badge}</span>
    </div>
  `).join('') + `<div style="margin-top:10px;font-size:10px;color:var(--muted2);line-height:1.6;">‚ö† Demo data shown ‚Äî CORS blocked live fetch. See iOS guide below for backend setup.</div>`;

  document.getElementById('updateTime').textContent = 'Demo mode ‚Äî CORS restricted';
  renderDemoPrediction();
  renderSeasonalPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  60-MINUTE WIND PREDICTION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Circular mean of angles (degrees) ‚Äî handles 359¬∞‚Üí1¬∞ wraparound correctly.
 */
function circularMean(angles) {
  const sinSum = angles.reduce((s, a) => s + Math.sin(a * Math.PI / 180), 0);
  const cosSum = angles.reduce((s, a) => s + Math.cos(a * Math.PI / 180), 0);
  let mean = Math.atan2(sinSum / angles.length, cosSum / angles.length) * 180 / Math.PI;
  return ((mean % 360) + 360) % 360;
}

/**
 * Circular diff: signed angle from a‚Üíb in (-180, 180]
 */
function circDiff(a, b) {
  return ((b - a + 540) % 360) - 180;
}

/**
 * Linear regression on a 1D array (x = indices). Returns {slope, intercept, r2}.
 */
function linReg(ys) {
  const n = ys.length;
  const xMean = (n - 1) / 2;
  const yMean = ys.reduce((s, v) => s + v, 0) / n;
  let num = 0, den = 0, ssRes = 0, ssTot = 0;
  ys.forEach((y, i) => {
    num += (i - xMean) * (y - yMean);
    den += (i - xMean) ** 2;
    ssTot += (y - yMean) ** 2;
  });
  const slope = den > 0 ? num / den : 0;
  const intercept = yMean - slope * xMean;
  ys.forEach((y, i) => { ssRes += (y - (intercept + slope * i)) ** 2; });
  const r2 = ssTot > 0 ? Math.max(0, 1 - ssRes / ssTot) : 0;
  return { slope, intercept, r2 };
}

/**
 * Exponentially-weighted moving average of a series.
 * alpha: smoothing factor 0‚Äì1 (higher = more weight on recent).
 */
function ewma(series, alpha = 0.15) {
  let val = series[0];
  for (let i = 1; i < series.length; i++) val = alpha * series[i] + (1 - alpha) * val;
  return val;
}

/**
 * Predict direction using circular linear regression on unwrapped angles.
 * Returns { predDeg, slopeDegPerObs, r2 }
 */
function predictDirection(dirs, stepsAhead) {
  // Unwrap angles to avoid 359‚Üí1 discontinuities
  const unwrapped = [dirs[0]];
  for (let i = 1; i < dirs.length; i++) {
    const delta = circDiff(dirs[i - 1], dirs[i]);
    unwrapped.push(unwrapped[i - 1] + delta);
  }
  const reg = linReg(unwrapped);
  const rawPred = reg.intercept + reg.slope * (dirs.length - 1 + stepsAhead);
  const predDeg = ((rawPred % 360) + 360) % 360;
  return { predDeg, slopeDegPerObs: reg.slope, r2: reg.r2 };
}

/**
 * Chicago Lake Michigan local knowledge adjustments.
 * Returns { spdAdj (kts), dirAdj (¬∞), note, icon }
 */
function localKnowledgeAdj(latestDir, latestSpd, hourCST) {
  const dir = degToCompass(latestDir);
  const month = new Date().getMonth();
  const sp = getSeasonalProfile();
  let spdAdj = 0, dirAdj = 0, note = '', icon = 'üåä';

  // Lake breeze probability this hour ‚Äî scale adj by seasonal profile
  const lbProb = (sp.lakeBreezeProbByHour || Array(24).fill(0))[hourCST] || 0;

  if (hourCST >= 11 && hourCST <= 16 && ['S','SSW','SW','SE','SSE'].includes(dir) && latestSpd < 12 && lbProb > 15) {
    // Lake breeze initiation ‚Äî stronger in June/July, weaker May/Sep
    const adjStrength = lbProb / 100;
    dirAdj = -20 * adjStrength;
    spdAdj = +1.5 * adjStrength;
    note = `${sp.name} lake breeze window: ${lbProb}% probability this hour. ${lbProb > 35 ? 'High chance of NE fill from the right ‚Äî direction may back 15‚Äì30¬∞ in next 60 min.' : 'Moderate chance. Watch for chop line offshore indicating breeze front.'}`;
    icon = 'üå¨Ô∏è';
  } else if (['W','NW','WNW'].includes(dir) && latestSpd > 10) {
    spdAdj = hourCST > 16 ? -1.5 : +0.5;
    note = month === 8
      ? `September W/NW ‚Äî best sustained pressure of the year. ${hourCST > 16 ? 'May ease slightly after sunset.' : 'Expect to hold or build through afternoon.'}`
      : `Post-frontal W/NW: ${hourCST > 16 ? 'easing after 4pm as land cools.' : 'steady pressure, may build slightly.'}`;
    icon = 'üåÄ';
  } else if (['S','SSW','SSE'].includes(dir)) {
    dirAdj = -8;
    note = month === 7
      ? 'August southerly ‚Äî narrowed land-sea differential. Pressure lanes offshore key. Wind may hole near Navy Pier for extended periods.'
      : 'Southerly flow: city thermal creates left-of-mean bias near shore. Watch for holes near Navy Pier.';
    icon = 'üèôÔ∏è';
  } else if (latestSpd < 5) {
    note = `Light air in ${sp.name}. ${month === 6 ? 'July light air often precedes lake breeze arrival ‚Äî stay patient, watch offshore.' : 'Lake thermals dominate near shore. Prediction confidence drops significantly.'}`;
    icon = 'üçÉ';
  } else {
    note = `${dir} at ${latestSpd.toFixed(0)} kts. ${sp.name} character: ${sp.shiftCharacter}. Shift frequency avg: ${sp.shiftFreqPerHr}√ó/hr.`;
    icon = '‚öì';
  }

  return { spdAdj, dirAdj, note, icon };
}

/**
 * Main prediction function. Takes full parsedData array.
 * Returns structured prediction object.
 */
function computePrediction(data) {
  if (!data || data.length < 15) return null;

  // Use last 60 obs (2 hrs) for trend; shorter windows for near-term signals
  const window60 = data.slice(-60);   // up to 120 min of 2-min data
  const window30 = data.slice(-30);   // 60 min
  const window10 = data.slice(-10);   // 20 min

  const latest   = data[data.length - 1];
  const spds60   = window60.map(d => d.spdKts);
  const spds30   = window30.map(d => d.spdKts);
  const dirs60   = window60.map(d => d.dir);
  const dirs30   = window30.map(d => d.dir);
  const gusts30  = window30.map(d => d.gstKts);

  // ‚îÄ‚îÄ SIGNAL 1: Linear regression on speed (60-obs window) ‚îÄ‚îÄ
  const spdReg60  = linReg(spds60);
  // Project 30 steps ahead (= +60 min of 2-min data)
  const stepsAhead60 = 30;
  const stepsAhead30 = 15;
  const spdLR60 = spdReg60.intercept + spdReg60.slope * (spds60.length - 1 + stepsAhead60);

  // ‚îÄ‚îÄ SIGNAL 2: Linear regression on speed (30-obs window) ‚îÄ‚îÄ
  const spdReg30  = linReg(spds30);
  const spdLR30 = spdReg30.intercept + spdReg30.slope * (spds30.length - 1 + stepsAhead60);

  // ‚îÄ‚îÄ For 30-min horizon: same signals projected 15 steps ‚îÄ‚îÄ
  const spdLR60_30 = spdReg60.intercept + spdReg60.slope * (spds60.length - 1 + stepsAhead30);
  const spdLR30_30 = spdReg30.intercept + spdReg30.slope * (spds30.length - 1 + stepsAhead30);

  // ‚îÄ‚îÄ SIGNAL 3: EWMA-based extrapolation ‚îÄ‚îÄ
  const ewmaSpd  = ewma(spds30, 0.12);
  const spdTrend = spds30[spds30.length - 1] - spds30[0]; // raw trend over 30 obs
  const spdEWMA  = Math.max(0, ewmaSpd + spdTrend * 0.35);
  const spdEWMA30 = Math.max(0, ewmaSpd + spdTrend * 0.175); // half trend for 30-min

  // ‚îÄ‚îÄ SIGNAL 4: Acceleration (2nd derivative of speed) ‚îÄ‚îÄ
  const accel10  = window10.slice(-5).map(d => d.spdKts);
  const accel10b = window10.slice(0, 5).map(d => d.spdKts);
  const accelSignal = (accel10.reduce((s,v)=>s+v,0)/5) - (accel10b.reduce((s,v)=>s+v,0)/5);
  const spdAccel   = latest.spdKts + accelSignal * 3;   // 60-min
  const spdAccel30 = latest.spdKts + accelSignal * 1.5; // 30-min

  // ‚îÄ‚îÄ ENSEMBLE SPEED 60-min (weighted) ‚îÄ‚îÄ
  const w1 = 0.30 * spdReg60.r2 + 0.05;
  const w2 = 0.25 * spdReg30.r2 + 0.05;
  const w3 = 0.25;
  const w4 = 0.15;
  const wTotal = w1 + w2 + w3 + w4;
  let predSpd = (w1 * spdLR60 + w2 * spdLR30 + w3 * spdEWMA + w4 * spdAccel) / wTotal;
  predSpd = Math.max(0, predSpd);

  // ‚îÄ‚îÄ ENSEMBLE SPEED 30-min (same weights, 30-min projections) ‚îÄ‚îÄ
  let predSpd30 = (w1 * spdLR60_30 + w2 * spdLR30_30 + w3 * spdEWMA30 + w4 * spdAccel30) / wTotal;
  predSpd30 = Math.max(0, predSpd30);

  // ‚îÄ‚îÄ SIGNAL 5: Direction prediction ‚îÄ‚îÄ
  const stepsAhead = stepsAhead60; // keep for back-compat signal cards
  const dirPred60 = predictDirection(dirs60, stepsAhead60);
  const dirPred30_60 = predictDirection(dirs30, stepsAhead60);
  const dirPred30_30 = predictDirection(dirs30, stepsAhead30);
  const dirPred60_30 = predictDirection(dirs60, stepsAhead30);

  // 60-min blended direction
  const dw1 = dirPred60.r2 + 0.1, dw2 = dirPred30_60.r2 + 0.1;
  const blendedDir = dirPred60.predDeg + circDiff(dirPred60.predDeg, dirPred30_60.predDeg) * (dw2 / (dw1 + dw2));
  let predDir = ((blendedDir % 360) + 360) % 360;

  // 30-min blended direction
  const dw1_30 = dirPred60_30.r2 + 0.1, dw2_30 = dirPred30_30.r2 + 0.1;
  const blendedDir30 = dirPred60_30.predDeg + circDiff(dirPred60_30.predDeg, dirPred30_30.predDeg) * (dw2_30 / (dw1_30 + dw2_30));
  let predDir30 = ((blendedDir30 % 360) + 360) % 360;

  // ‚îÄ‚îÄ SIGNAL 6: Gust ratio model ‚îÄ‚îÄ
  const avgGustRatio = gusts30.reduce((s, g, i) => s + g / Math.max(spds30[i], 0.5), 0) / gusts30.length;
  let predGust   = Math.max(predSpd,   predSpd   * avgGustRatio);
  let predGust30 = Math.max(predSpd30, predSpd30 * avgGustRatio);

  // ‚îÄ‚îÄ SIGNAL 7: Local knowledge adjustment ‚îÄ‚îÄ
  const now = new Date();
  const hourCST = parseInt(new Intl.DateTimeFormat('en-US',{hour:'numeric',hour12:false,timeZone:'America/Chicago'}).format(now)) % 24;
  const lk = localKnowledgeAdj(latest.dir, latest.spdKts, hourCST);
  predSpd   = Math.max(0, predSpd   + lk.spdAdj);
  predSpd30 = Math.max(0, predSpd30 + lk.spdAdj * 0.6); // smaller adj at 30-min
  predDir   = ((predDir   + lk.dirAdj) % 360 + 360) % 360;
  predDir30 = ((predDir30 + lk.dirAdj * 0.6) % 360 + 360) % 360;

  // ‚îÄ‚îÄ SIGNAL 8: HRRR model blend ‚îÄ‚îÄ
  const model = getModelPlusSixty();
  let modelSignal = null;
  if (model) {
    const modelWeight = 0.20;
    const statWeight  = 1 - modelWeight;
    const preSpdBlend = predSpd;
    // 60-min blend: full 20% model weight
    predSpd  = predSpd  * statWeight + model.spd  * modelWeight;
    predGust = predGust * statWeight + model.gust * modelWeight;
    const dirDiffModel = circDiff(predDir, model.dir);
    predDir  = ((predDir + dirDiffModel * modelWeight) % 360 + 360) % 360;
    // 30-min blend: 10% model weight (Crib observations dominate at shorter range)
    const modelWeight30 = 0.10;
    predSpd30  = predSpd30  * (1 - modelWeight30) + model.spd  * modelWeight30;
    predGust30 = predGust30 * (1 - modelWeight30) + model.gust * modelWeight30;
    const dirDiffModel30 = circDiff(predDir30, model.dir);
    predDir30  = ((predDir30 + dirDiffModel30 * modelWeight30) % 360 + 360) % 360;
    modelSignal = {
      spd: model.spd, dir: model.dir, gust: model.gust,
      spdContrib: (model.spd - preSpdBlend) * modelWeight,
      dirContrib: dirDiffModel * modelWeight
    };
  }

  // ‚îÄ‚îÄ CONFIDENCE SCORING ‚îÄ‚îÄ
  // Multiple penalty/bonus factors:
  let conf = 85; // start optimistic

  // Penalty: low R¬≤ on regression
  if (spdReg60.r2 < 0.5) conf -= 15;
  else if (spdReg60.r2 < 0.75) conf -= 7;

  // Penalty: high direction oscillation (std dev of circular diffs)
  const dirDiffs = dirs30.slice(1).map((d, i) => Math.abs(circDiff(dirs30[i], d)));
  const dirOscil = dirDiffs.reduce((s, v) => s + v, 0) / dirDiffs.length;
  if (dirOscil > 15) conf -= 20;
  else if (dirOscil > 8) conf -= 10;
  else conf += 5;

  // Penalty: high gust ratio (gusty = less predictable)
  if (avgGustRatio > 1.5) conf -= 15;
  else if (avgGustRatio > 1.3) conf -= 7;
  else conf += 5;

  // Penalty: light air
  if (latest.spdKts < 4) conf -= 20;
  else if (latest.spdKts < 7) conf -= 8;

  // Penalty: large ensemble spread between methods
  const spdSpread = Math.max(spdLR60, spdLR30, spdEWMA, spdAccel) -
                    Math.min(spdLR60, spdLR30, spdEWMA, spdAccel);
  if (spdSpread > 6) conf -= 12;
  else if (spdSpread > 3) conf -= 5;

  // Bonus: strong consistent signal
  if (dirPred60.r2 > 0.8 && spdReg60.r2 > 0.8) conf += 8;

  conf = Math.min(95, Math.max(12, Math.round(conf)));
  conf = applySeasonalConfModifier(conf);
  conf = Math.min(95, Math.max(12, conf + getModelSpreadPenalty()));

  // 30-min confidence: same base but add 10-15 points (shorter horizon = more reliable)
  let conf30 = Math.min(95, conf + 12);
  let confLevel30;
  if (conf30 >= 75) confLevel30 = 'HIGH';
  else if (conf30 >= 55) confLevel30 = 'MODERATE';
  else confLevel30 = 'LOW';

  // ‚îÄ‚îÄ CONFIDENCE LEVEL LABEL ‚îÄ‚îÄ
  let confLevel, confColor;
  if (conf >= 75) { confLevel = 'HIGH';   confColor = '#39ff8c'; }
  else if (conf >= 55) { confLevel = 'MODERATE'; confColor = '#00d4ff'; }
  else if (conf >= 35) { confLevel = 'LOW';  confColor = '#ffb830'; }
  else               { confLevel = 'POOR'; confColor = '#ff3d5a'; }

  // ‚îÄ‚îÄ DELTAS vs current ‚îÄ‚îÄ
  const spdDelta    = predSpd   - latest.spdKts;
  const spdDelta30  = predSpd30 - latest.spdKts;
  const dirDeltaDeg   = circDiff(latest.dir, predDir);
  const dirDeltaDeg30 = circDiff(latest.dir, predDir30);
  const gustDelta   = predGust   - latest.gstKts;
  const gustDelta30 = predGust30 - latest.gstKts;

  // ‚îÄ‚îÄ SIGNAL CARDS DATA ‚îÄ‚îÄ
  const signals = [
    {
      icon: 'üìê',
      name: 'Linear Regression (60-obs)',
      weight: spdReg60.r2 > 0.7 ? 'high' : spdReg60.r2 > 0.4 ? 'medium' : 'low',
      weightLabel: spdReg60.r2 > 0.7 ? 'HIGH WEIGHT' : spdReg60.r2 > 0.4 ? 'MED WEIGHT' : 'LOW WEIGHT',
      desc: `Fits a best-fit line to the last ${window60.length} observations (${(window60.length*2)} min). Slope: ${(spdReg60.slope * 30).toFixed(2)} kts/hr. R¬≤=${spdReg60.r2.toFixed(2)}.`,
      value: `‚Üí Speed signal: ${spdLR60.toFixed(1)} kts`
    },
    {
      icon: '„Ä∞Ô∏è',
      name: 'EWMA Trend Extrapolation',
      weight: 'medium',
      weightLabel: 'MED WEIGHT',
      desc: `Exponentially-weighted moving average (Œ±=0.12) on last 60 min. Reduces noise from gusts. EWMA base: ${ewmaSpd.toFixed(1)} kts; trend term: ${(spdTrend*0.35).toFixed(2)} kts.`,
      value: `‚Üí Speed signal: ${spdEWMA.toFixed(1)} kts`
    },
    {
      icon: 'üöÄ',
      name: 'Acceleration Signal (20-min)',
      weight: Math.abs(accelSignal) > 1 ? 'medium' : 'low',
      weightLabel: Math.abs(accelSignal) > 1 ? 'MED WEIGHT' : 'LOW WEIGHT',
      desc: `2nd-derivative (rate-of-change) over last 20 min. Accel: ${accelSignal > 0 ? '+' : ''}${accelSignal.toFixed(2)} kts/10min. ${Math.abs(accelSignal) < 0.5 ? 'Negligible ‚Äî speed is settling.' : accelSignal > 0 ? 'Building trend detected.' : 'Easing trend detected.'}`,
      value: `‚Üí Speed signal: ${spdAccel.toFixed(1)} kts`
    },
    {
      icon: 'üß≠',
      name: 'Direction Veer/Back Rate',
      weight: dirPred60.r2 > 0.6 ? 'high' : dirPred60.r2 > 0.3 ? 'medium' : 'low',
      weightLabel: dirPred60.r2 > 0.6 ? 'HIGH WEIGHT' : dirPred60.r2 > 0.3 ? 'MED WEIGHT' : 'LOW WEIGHT',
      desc: `Circular linear regression on unwrapped angles. 60-obs slope: ${(dirPred60.slopeDegPerObs * 30).toFixed(1)}¬∞/hr. Oscillation: ¬±${dirOscil.toFixed(1)}¬∞. ${dirDeltaDeg > 5 ? 'Veering (clockwise).' : dirDeltaDeg < -5 ? 'Backing (counter-clockwise).' : 'Direction stable.'}`,
      value: `‚Üí Direction signal: ${Math.round(predDir)}¬∞ (${degToCompass(predDir)})`
    },
    {
      icon: 'üí®',
      name: 'Gust Ratio Model',
      weight: avgGustRatio > 1.4 ? 'medium' : 'low',
      weightLabel: 'MED WEIGHT',
      desc: `Avg gust/speed ratio over last 60 min: √ó${avgGustRatio.toFixed(2)}. ${avgGustRatio > 1.4 ? 'High ratio = gusty, less predictable.' : 'Low ratio = laminar flow, more predictable.'} Applied to predicted speed.`,
      value: `‚Üí Gust signal: ${predGust.toFixed(1)} kts`
    },
    {
      icon: lk.icon,
      name: 'Chicago Local Knowledge',
      weight: (lk.spdAdj !== 0 || lk.dirAdj !== 0) ? 'medium' : 'low',
      weightLabel: (lk.spdAdj !== 0 || lk.dirAdj !== 0) ? 'MED WEIGHT' : 'LOW WEIGHT',
      desc: lk.note,
      value: `‚Üí Adj: ${lk.spdAdj >= 0 ? '+' : ''}${lk.spdAdj.toFixed(1)} kts, ${lk.dirAdj >= 0 ? '+' : ''}${lk.dirAdj.toFixed(0)}¬∞ dir`
    },
    {
      icon: 'üåê',
      name: 'HRRR 3km Model (+60min)',
      weight: modelSignal ? 'medium' : 'low',
      weightLabel: modelSignal ? 'MED WEIGHT (20%)' : 'NOT LOADED',
      desc: modelSignal
        ? `HRRR (High-Resolution Rapid Refresh) at 3km resolution ‚Äî updates every hour, assimilates radar every 15 min. Best available model for Lake Michigan coastal wind at this range. GFS 13km shown alongside for spread. ${Math.abs(modelSignal.spdContrib) < 0.3 ? 'HRRR agrees with statistical ensemble.' : `HRRR pulling prediction ${modelSignal.spdContrib > 0 ? 'up' : 'down'} by ${Math.abs(modelSignal.spdContrib).toFixed(1)} kts.`} ${getModelSpreadPenalty() < 0 ? '‚ö† High HRRR/GFS spread detected ‚Äî confidence reduced.' : ''}`
        : 'HRRR/GFS data not yet loaded. Statistical ensemble only.',
      value: modelSignal
        ? `‚Üí HRRR reads: ${degToCompass(modelSignal.dir)} ${modelSignal.spd.toFixed(1)} kts ¬∑ gust ${modelSignal.gust.toFixed(1)} kts`
        : '‚Üí Not available'
    }
  ];

  // ‚îÄ‚îÄ SIGNAL 9: Archive pattern match ‚îÄ‚îÄ
  const archive = matchArchivePattern(data);
  if (archive) {
    const aw = getArchiveSignalWeight();
    predSpd   = predSpd   * (1 - aw) + archive.predSpd * aw;
    predSpd30 = predSpd30 * (1 - aw * 0.5) + archive.predSpd * (aw * 0.5);
    const dArchive = circDiff(predDir, archive.predDir);
    predDir   = ((predDir + dArchive * aw) % 360 + 360) % 360;
    signals.push({
      icon: 'üóÇÔ∏è',
      name: 'Archive Pattern Match',
      weight: archive.matchScore > 55 ? 'medium' : 'low',
      weightLabel: archive.matchScore > 55 ? `MED WEIGHT (${Math.round(aw*100)}%)` : `LOW WEIGHT (${Math.round(aw*100)}%)`,
      desc: `${archive.label} ‚Äî top score ${archive.matchScore}/70 across ${archive.nMatches} historical analogs. Blends past outcomes for similar conditions (dir, speed, trend, season).`,
      value: `‚Üí Archive signal: ${degToCompass(archive.predDir)} ${archive.predSpd.toFixed(1)} kts`
    });
  } else if (ARCHIVE_BASE_URL) {
    signals.push({
      icon: 'üóÇÔ∏è',
      name: 'Archive Pattern Match',
      weight: 'low',
      weightLabel: 'NOT LOADED',
      desc: 'Pattern archive not yet loaded or insufficient data for matching.',
      value: '‚Üí Not available'
    });
  }

  // ‚îÄ‚îÄ SIGNAL 10: Upstream station signal ‚îÄ‚îÄ
  const upstream = upstreamSignalData;
  if (upstream && Math.abs(upstream.spdDiff) > 3) {
    const uw = 0.08;
    predSpd   = predSpd   * (1 - uw) + upstream.upstreamSpd * uw;
    predSpd30 = predSpd30 * (1 - uw * 0.5) + upstream.upstreamSpd * (uw * 0.5);
    const dUpstream = upstream.upstreamDir != null ? circDiff(predDir, upstream.upstreamDir) : 0;
    predDir   = ((predDir + dUpstream * uw * 0.5) % 360 + 360) % 360;
    const sigName = upstream.signal === 'building' ? '‚¨Ü Building' :
                    upstream.signal === 'fading'   ? '‚¨á Fading'   :
                    upstream.signal === 'shifting'  ? '‚Ü∫ Shifting' : '‚Üí Stable';
    signals.push({
      icon: 'üì°',
      name: `Upstream Station ‚Äî ${sigName}`,
      weight: 'medium',
      weightLabel: 'LOW WEIGHT (8%)',
      desc: upstream.note,
      value: `‚Üí ${upstream.upstreamName}: ${upstream.upstreamSpd.toFixed(0)} kts ${upstream.upstreamDir != null ? degToCompass(upstream.upstreamDir) : ''}`
    });
  }

  return {
    predSpd, predDir, predGust,
    predSpd30, predDir30, predGust30,
    spdDelta, dirDeltaDeg, gustDelta,
    spdDelta30, dirDeltaDeg30, gustDelta30,
    conf, confLevel, confColor,
    conf30, confLevel30,
    avgGustRatio, spdReg60, dirOscil,
    modelSignal, signals
  };
}

function renderPrediction(data) {
  const p = computePrediction(data);
  if (!p) {
    document.getElementById('signalGrid').innerHTML =
      `<div class="signal-row"><div class="signal-content"><div class="signal-name">Insufficient data</div><div class="signal-desc">Need at least 15 observations to compute prediction.</div></div></div>`;
    return;
  }

  // Timestamp
  const now = new Date();
  const future30 = new Date(now.getTime() + 1800000);
  const future60 = new Date(now.getTime() + 3600000);
  document.getElementById('predTimestamp').textContent =
    `Now: ${now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'})} ‚Üí +30: ${future30.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'})} ‚Üí +60: ${future60.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'})} CST`;

  // ‚îÄ‚îÄ 30-MINUTE CARDS ‚îÄ‚îÄ
  document.getElementById('pred30Spd').textContent = p.predSpd30.toFixed(1);
  const s30sign = p.spdDelta30 >= 0 ? '+' : '';
  document.getElementById('pred30SpdDelta').textContent = `${s30sign}${p.spdDelta30.toFixed(1)} kts vs now`;
  document.getElementById('pred30SpdDelta').className = 'pred-30-delta ' +
    (p.spdDelta30 > 1 ? 'delta-up' : p.spdDelta30 < -1 ? 'delta-down' : 'delta-same');

  document.getElementById('pred30DirArrow').textContent = dirArrow(p.predDir30);
  document.getElementById('pred30Dir').textContent = `${degToCompass(p.predDir30)} ${Math.round(p.predDir30)}¬∞`;
  const d30sign = p.dirDeltaDeg30 >= 0 ? '+' : '';
  const vb30 = p.dirDeltaDeg30 > 3 ? 'Veering ‚Üí' : p.dirDeltaDeg30 < -3 ? '‚Üê Backing' : 'Steady';
  document.getElementById('pred30DirDelta').textContent = `${vb30} ${d30sign}${p.dirDeltaDeg30.toFixed(0)}¬∞`;

  document.getElementById('pred30Gust').textContent = p.predGust30.toFixed(1);
  const g30sign = p.gustDelta30 >= 0 ? '+' : '';
  document.getElementById('pred30GustDelta').textContent = `${g30sign}${p.gustDelta30.toFixed(1)} kts vs now`;

  // Confidence improvement note
  const confNote = document.getElementById('confImprovementNote');
  if (confNote) {
    const diff = p.conf30 - p.conf;
    confNote.textContent = `+30 min confidence: ${p.conf30}% (${p.confLevel30}) ‚Äî ${diff > 0 ? `+${diff}% more reliable than 60-min outlook` : 'similar to 60-min'}`;
    confNote.style.color = p.conf30 >= 75 ? 'var(--accent3)' : p.conf30 >= 55 ? 'var(--accent)' : 'var(--warn)';
  }

  // Speed card
  document.getElementById('predSpd').textContent = p.predSpd.toFixed(1);
  const spdDeltaEl = document.getElementById('predSpdDelta');
  const sdSign = p.spdDelta >= 0 ? '+' : '';
  spdDeltaEl.textContent = `${sdSign}${p.spdDelta.toFixed(1)} kts vs now`;
  spdDeltaEl.className = 'pred-card-delta ' + (p.spdDelta > 1 ? 'delta-up' : p.spdDelta < -1 ? 'delta-down' : 'delta-same');

  // Direction card
  document.getElementById('predDirArrow').textContent = dirArrow(p.predDir);
  document.getElementById('predDir').textContent = degToCompass(p.predDir);
  document.getElementById('predDirDeg').textContent = `${Math.round(p.predDir)}¬∞`;
  const dirDeltaEl = document.getElementById('predDirDelta');
  const ddSign = p.dirDeltaDeg >= 0 ? '+' : '';
  const veerBk = p.dirDeltaDeg > 3 ? 'Veering ‚Üí' : p.dirDeltaDeg < -3 ? '‚Üê Backing' : 'Steady';
  dirDeltaEl.textContent = `${veerBk}  ${ddSign}${p.dirDeltaDeg.toFixed(0)}¬∞ vs now`;
  dirDeltaEl.className = 'pred-card-delta ' + (Math.abs(p.dirDeltaDeg) > 10 ? 'delta-up' : 'delta-same');

  // Gust card
  document.getElementById('predGust').textContent = p.predGust.toFixed(1);
  const gustDeltaEl = document.getElementById('predGustDelta');
  const gdSign = p.gustDelta >= 0 ? '+' : '';
  gustDeltaEl.textContent = `${gdSign}${p.gustDelta.toFixed(1)} kts vs now`;
  gustDeltaEl.className = 'pred-card-delta ' + (p.gustDelta > 1 ? 'delta-up' : p.gustDelta < -1 ? 'delta-down' : 'delta-same');

  // Confidence arc
  const circ = 2 * Math.PI * 42; // 263.9
  const offset = circ * (1 - p.conf / 100);
  const arc = document.getElementById('confArc');
  arc.style.strokeDashoffset = offset.toFixed(1);
  arc.style.stroke = p.confColor;
  document.getElementById('confPct').textContent = p.conf + '%';
  document.getElementById('confPct').style.color = p.confColor;
  document.getElementById('confLevel').textContent = p.confLevel;
  document.getElementById('confLevel').style.color = p.confColor;

  // Signal grid
  document.getElementById('signalGrid').innerHTML = p.signals.map(s => `
    <div class="signal-row">
      <div class="signal-icon">${s.icon}</div>
      <div class="signal-content">
        <div class="signal-name">
          ${s.name}
          <span class="signal-weight ${s.weight}">${s.weightLabel}</span>
        </div>
        <div class="signal-desc">${s.desc}</div>
        <div class="signal-value">${s.value}</div>
      </div>
    </div>
  `).join('');

  // Render strategy brief
  renderStrategy(data, p);
}

// Also add to loadDemoData's prediction section
function renderDemoPrediction() {
  // Use demo data array to feed the engine
  const demoFull = [];
  // Simulate 30-obs (~60 min) of 2-min data from our known demo readings
  const template = [
    { spdKts:6.0, gstKts:7.6, dir:193 },
    { spdKts:4.8, gstKts:6.2, dir:200 },
    { spdKts:5.5, gstKts:7.0, dir:220 },
    { spdKts:6.6, gstKts:8.0, dir:243 },
    { spdKts:8.2, gstKts:9.5, dir:256 },
    { spdKts:9.7, gstKts:11.0, dir:263 },
    { spdKts:11.3, gstKts:12.6, dir:269 },
    { spdKts:12.8, gstKts:14.0, dir:268 },
    { spdKts:14.6, gstKts:15.7, dir:265 },
    { spdKts:13.2, gstKts:14.5, dir:270 },
    { spdKts:12.1, gstKts:13.2, dir:272 },
    { spdKts:11.5, gstKts:12.0, dir:274 },
    { spdKts:10.8, gstKts:11.5, dir:276 },
    { spdKts:10.2, gstKts:11.0, dir:278 },
    { spdKts:9.7,  gstKts:10.5, dir:280 },
  ];
  template.forEach((t, i) => {
    demoFull.push({ ...t, airF:'46.0', rh:71, timeLabel:`${String(9+Math.floor(i/30)).padStart(2,'0')}:${String((i*2)%60).padStart(2,'0')}` });
  });
  renderPrediction(demoFull);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NWS NEARSHORE MARINE FORECAST (LMZ740‚Äì742)
//  API: api.weather.gov ¬∑ No key required ¬∑ CORS OK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let nwsForecastData = null;
let modelForecastData = null;

async function fetchNWSForecast() {
  const listRes = await fetchWithTimeout('https://api.weather.gov/products/types/NSH/locations/LOT', {
    headers: { 'User-Agent': 'CribWindDashboard/1.0 (chicago-sailing-weather)' }
  }, 8000);
  if (!listRes.ok) throw new Error(`NWS list HTTP ${listRes.status}`);
  const listData = await listRes.json();
  const products = listData['@graph'];
  if (!products || !products.length) throw new Error('No NSH products');
  const latestId = products[0].id;
  const prodRes = await fetchWithTimeout(`https://api.weather.gov/products/${latestId}`, {
    headers: { 'User-Agent': 'CribWindDashboard/1.0 (chicago-sailing-weather)' }
  }, 8000);
  if (!prodRes.ok) throw new Error(`NWS product HTTP ${prodRes.status}`);
  const prodData = await prodRes.json();
  return { text: prodData.productText, issuanceTime: prodData.issuanceTime };
}

function normalizeDir(raw) {
  if (!raw) return null;
  const map = {
    'north':'N','south':'S','east':'E','west':'W',
    'northwest':'NW','northeast':'NE','southwest':'SW','southeast':'SE',
    'north northwest':'NNW','north northeast':'NNE',
    'south southwest':'SSW','south southeast':'SSE',
    'west northwest':'WNW','west southwest':'WSW',
    'east northeast':'ENE','east southeast':'ESE',
  };
  return map[raw.toLowerCase().trim()] || raw.toUpperCase().trim();
}

function parseNWSText(rawText) {
  const periodRe = /\.(REST OF TODAY|TODAY|TONIGHT|MONDAY|TUESDAY|WEDNESDAY|THURSDAY|FRIDAY|SATURDAY|SUNDAY|MONDAY NIGHT|TUESDAY NIGHT|WEDNESDAY NIGHT|THURSDAY NIGHT|FRIDAY NIGHT|SATURDAY NIGHT|SUNDAY NIGHT)\.\.\./gi;
  const parts = rawText.split(periodRe);
  const periods = [];
  for (let i = 1; i < parts.length; i += 2) {
    const name = parts[i].trim();
    const body = (parts[i + 1] || '').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
    if (!body) continue;
    const windMatch = body.match(
      /([NSEW]+(?:\s[NSEW]+)?|North|South|East|West|Northwest|Northeast|Southwest|Southeast)\s+winds?\s+(?:around\s+)?(\d+)(?:\s+to\s+(\d+))?\s+kt/i
    );
    const becomingMatch = body.match(
      /becoming\s+([NSEW]+(?:\s[NSEW]+)?|North|South|East|West|Northwest|Northeast|Southwest|Southeast)/i
    );
    const windDir   = windMatch ? normalizeDir(windMatch[1]) : null;
    const windSpd   = windMatch ? parseInt(windMatch[2]) : null;
    const windSpdHi = windMatch ? (windMatch[3] ? parseInt(windMatch[3]) : windSpd) : null;
    const shiftDir  = becomingMatch ? normalizeDir(becomingMatch[1]) : null;
    const hasShift  = !!shiftDir && shiftDir !== windDir;
    const hasAdvisory = /ADVISORY|WARNING|WATCH/i.test(body);
    periods.push({ name, text: body, windDir, windSpd, windSpdHi, shiftDir, hasShift, hasAdvisory });
    if (periods.length >= 5) break;
  }
  return periods;
}

function renderNWSForecast(rawData) {
  const periods = parseNWSText(rawData.text);
  nwsForecastData = periods;
  const issued = new Date(rawData.issuanceTime);
  document.getElementById('nwsIssued').textContent =
    `LMZ740‚Äì742 ¬∑ Issued ${issued.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'})} CST ¬∑ ${issued.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',timeZone:'America/Chicago'})}`;
  document.getElementById('nwsStatus').textContent = 'LIVE';
  document.getElementById('nwsStatus').className = 'marine-status status-live';
  if (!periods.length) {
    document.getElementById('nwsPeriods').innerHTML = `<div style="color:var(--muted);font-size:12px;">Could not parse forecast. Check <a href="https://forecast.weather.gov/product.php?site=lot&product=nsh&issuedby=lot" target="_blank" style="color:var(--accent)">weather.gov/lot/marine</a> directly.</div>`;
    return;
  }
  const alertPeriod = periods.find(p => p.hasShift);
  const alertEl = document.getElementById('nwsShiftAlert');
  if (alertPeriod) {
    alertEl.style.display = 'block';
    alertEl.innerHTML = `‚ö† Wind shift forecast: <strong>${alertPeriod.windDir || '?'} ‚Üí ${alertPeriod.shiftDir}</strong> during ${alertPeriod.name}`;
  }
  function highlightText(text) {
    return text
      .replace(/(\d+)\s+to\s+(\d+)\s+kt/gi, '<span class="nws-highlight">$1‚Äì$2 kt</span>')
      .replace(/around\s+(\d+)\s+kt/gi, '<span class="nws-highlight">~$1 kt</span>')
      .replace(/\b(NW|NE|SW|SE|SSW|SSE|NNW|NNE|WNW|WSW|ENE|ESE|North|South|East|West|Northwest|Northeast|Southwest|Southeast)\b/g,
        '<span class="nws-highlight">$1</span>')
      .replace(/\b(SMALL CRAFT ADVISORY|GALE WARNING|STORM WARNING)\b/gi,
        '<strong style="color:var(--danger)">$1</strong>');
  }
  document.getElementById('nwsPeriods').innerHTML = periods.map(p => `
    <div class="nws-period">
      <div class="nws-period-name">${p.name}${p.hasAdvisory ? ' <strong style="color:var(--danger)">‚ö†</strong>' : ''}</div>
      <div class="nws-period-text">${highlightText(p.text)}</div>
    </div>
  `).join('');
  document.getElementById('chip-nws').classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HRRR + GFS DUAL MODEL FORECAST
//  HRRR: 3km, hourly updates, 48h, North America only
//  GFS:  13km, 6-hourly updates, fallback + 48h+
//  Both via api.open-meteo.com ¬∑ No key ¬∑ CORS OK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// HRRR via dedicated /v1/gfs endpoint ‚Äî 15-min resolution, 48h
const HRRR_URL =
  'https://api.open-meteo.com/v1/gfs' +
  '?latitude=41.916&longitude=-87.573' +
  '&minutely_15=wind_speed_10m,wind_direction_10m,wind_gusts_10m' +
  '&wind_speed_unit=kn&forecast_days=2&timezone=GMT' +
  '&models=ncep_hrrr_conus';

// GFS fallback ‚Äî hourly, 48h (also used for spread calculation)
const GFS_URL =
  'https://api.open-meteo.com/v1/gfs' +
  '?latitude=41.916&longitude=-87.573' +
  '&hourly=wind_speed_10m,wind_direction_10m,wind_gusts_10m' +
  '&wind_speed_unit=kn&forecast_days=2&timezone=GMT' +
  '&models=ncep_gfs013';

let gfsForecastData = null; // raw GFS hourly for spread calc

async function fetchOpenMeteo() {
  // Fetch HRRR and GFS in parallel
  const [hrrrRes, gfsRes] = await Promise.allSettled([
    fetchWithTimeout(HRRR_URL, {}, 12000).then(r => { if (!r.ok) throw new Error(`HRRR HTTP ${r.status}`); return r.json(); }),
    fetchWithTimeout(GFS_URL, {}, 12000).then(r  => { if (!r.ok) throw new Error(`GFS HTTP ${r.status}`);  return r.json(); })
  ]);

  const hrrrOk = hrrrRes.status === 'fulfilled';
  const gfsOk  = gfsRes.status  === 'fulfilled';

  if (!hrrrOk && !gfsOk) throw new Error('Both HRRR and GFS failed');

  return {
    hrrr: hrrrOk ? hrrrRes.value : null,
    gfs:  gfsOk  ? gfsRes.value  : null,
    hrrrFailed: !hrrrOk,
    gfsFailed:  !gfsOk
  };
}

function parseHRRR(data) {
  // HRRR returns minutely_15 ‚Äî 15-min intervals
  // API returns timezone=GMT strings WITHOUT 'Z' suffix ‚Äî must append 'Z' so JS
  // parses them as UTC, not local time. Otherwise index selection is wrong by
  // the browser's UTC offset (e.g. 6 hrs in CST).
  if (!data || !data.minutely_15) return [];
  const times  = data.minutely_15.time;
  const speeds = data.minutely_15.wind_speed_10m;
  const dirs   = data.minutely_15.wind_direction_10m;
  const gusts  = data.minutely_15.wind_gusts_10m;

  const now = new Date();
  // Round down to nearest 15 min in UTC
  const nowMs   = now.getTime();
  const nowSlot = new Date(Math.floor(nowMs / (15 * 60000)) * (15 * 60000));

  const rows = [];
  for (let i = 0; i < times.length; i++) {
    const t = new Date(times[i] + 'Z'); // force UTC parse
    if (t >= nowSlot) {
      rows.push({
        time:  t,
        label: t.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' }),
        spd:   Math.round(speeds[i] * 10) / 10,
        dir:   dirs[i],
        gust:  Math.round(gusts[i] * 10) / 10,
        isNow: t.getTime() === nowSlot.getTime(),
        model: 'HRRR'
      });
    }
    if (rows.length >= 13) break; // now + 12 √ó 15min = 3 hours
  }
  return rows;
}

function parseGFS(data) {
  // GFS returns hourly ‚Äî same UTC parse fix as parseHRRR
  if (!data || !data.hourly) return [];
  const times  = data.hourly.time;
  const speeds = data.hourly.wind_speed_10m;
  const dirs   = data.hourly.wind_direction_10m;
  const gusts  = data.hourly.wind_gusts_10m;

  const now = new Date();
  // Round down to current UTC hour
  const nowHour = new Date(Math.floor(now.getTime() / 3600000) * 3600000);
  const rows = [];
  for (let i = 0; i < times.length; i++) {
    const t = new Date(times[i] + 'Z'); // force UTC parse
    if (t >= nowHour) {
      rows.push({
        time:  t,
        label: t.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' }),
        spd:   Math.round(speeds[i] * 10) / 10,
        dir:   dirs[i],
        gust:  Math.round(gusts[i] * 10) / 10,
        isNow: t.getTime() === nowHour.getTime(),
        model: 'GFS'
      });
    }
    if (rows.length >= 13) break;
  }
  return rows;
}

/**
 * Compute model spread between HRRR and GFS at +1h.
 * Returns { spdSpread, dirSpread, highSpread } or null.
 */
function computeModelSpread(hrrrRows, gfsRows) {
  // Find +60min slot in each
  const hrrrPlus1 = hrrrRows.find((r, i) => i === 4); // 4 √ó 15min = +60min
  const gfsPlus1  = gfsRows.find((r, i)  => i === 1); // 1 √ó 60min = +60min
  if (!hrrrPlus1 || !gfsPlus1) return null;

  const spdSpread = Math.abs(hrrrPlus1.spd - gfsPlus1.spd);
  const dirSpread = Math.abs(circDiff(hrrrPlus1.dir, gfsPlus1.dir));
  const highSpread = spdSpread > 4 || dirSpread > 25;

  return { spdSpread, dirSpread, highSpread, hrrrPlus1, gfsPlus1 };
}

function renderOpenMeteo(data) {
  const hrrrRows = data.hrrr ? parseHRRR(data.hrrr) : [];
  const gfsRows  = data.gfs  ? parseGFS(data.gfs)   : [];

  // Use HRRR as primary display, fall back to GFS if HRRR failed
  const displayRows = hrrrRows.length ? hrrrRows : gfsRows;
  const primaryModel = hrrrRows.length ? 'HRRR 3km' : 'GFS 13km';
  const primaryColor = hrrrRows.length ? 'var(--accent3)' : 'var(--warn)';

  modelForecastData = displayRows;
  if (data.gfs) gfsForecastData = gfsRows;

  document.getElementById('meteoStatus').textContent = data.hrrrFailed ? 'GFS ONLY' : 'HRRR LIVE';
  document.getElementById('meteoStatus').className   = 'marine-status ' + (data.hrrrFailed ? 'status-error' : 'status-live');

  if (!displayRows.length) {
    document.getElementById('meteoPeriods').innerHTML = `<div style="color:var(--muted);font-size:12px;">No forecast data available.</div>`;
    return;
  }

  const maxSpd = Math.max(...displayRows.map(h => h.spd), 1);
  const resolution = hrrrRows.length ? '15-min' : '60-min';

  // Build GFS comparison column values indexed by closest time
  const gfsMap = {};
  gfsRows.forEach(g => { gfsMap[g.time.getHours()] = g; });

  document.getElementById('meteoPeriods').innerHTML = `
    <div style="font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">
      Primary: <span style="color:${primaryColor}">${primaryModel}</span> ¬∑ ${resolution} resolution
      ${gfsRows.length && hrrrRows.length ? '¬∑ <span style="color:var(--muted2)">GFS 13km shown for spread</span>' : ''}
    </div>
    <table class="meteo-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Dir</th>
          <th>Speed (kts)</th>
          <th>Gust</th>
          <th>Œî</th>
          ${hrrrRows.length && gfsRows.length ? '<th style="color:var(--muted2)">GFS</th>' : ''}
        </tr>
      </thead>
      <tbody>
        ${displayRows.map((h, i) => {
          const prev    = displayRows[i - 1];
          const diff    = prev ? h.spd - prev.spd : 0;
          const cls     = diff > 1 ? 'model-delta-up' : diff < -1 ? 'model-delta-down' : 'model-delta-same';
          const sym     = diff > 1 ? `‚Üë${diff.toFixed(1)}` : diff < -1 ? `‚Üì${Math.abs(diff).toFixed(1)}` : '‚Üí';
          const barW    = Math.round(h.spd / maxSpd * 100);
          const gfsHr   = gfsMap[h.time.getHours()];
          const spread  = gfsHr ? Math.abs(h.spd - gfsHr.spd) : null;
          const spreadCls = spread === null ? '' : spread > 4 ? 'model-delta-up' : spread > 2 ? '' : 'model-delta-same';
          return `<tr class="${h.isNow ? 'now-row' : ''}">
            <td>${h.isNow ? '‚ñ∂ ' : ''}${h.label}</td>
            <td><span style="font-family:'Syne',sans-serif;font-weight:700;">${dirArrow(h.dir)} ${degToCompass(h.dir)}</span><span style="color:var(--text);font-size:10px;margin-left:3px;">${Math.round(h.dir)}¬∞</span></td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-family:'Syne',sans-serif;font-weight:700;color:${primaryColor};min-width:32px;">${h.spd}</span>
                <div style="flex:1;height:2px;background:var(--border);border-radius:2px;">
                  <div style="width:${barW}%;height:100%;background:${primaryColor};border-radius:2px;"></div>
                </div>
              </div>
            </td>
            <td style="color:var(--warn);">${h.gust}</td>
            <td class="${cls}">${i === 0 ? '‚Äî' : sym}</td>
            ${hrrrRows.length && gfsRows.length
              ? `<td style="color:var(--text);font-size:10px;" class="${spreadCls}">
                  ${gfsHr ? `${dirArrow(gfsHr.dir)} ${gfsHr.spd} <span style="color:var(--text);font-size:10px;">${Math.round(gfsHr.dir)}¬∞</span>` : '‚Äî'}
                </td>`
              : ''}
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;

  // Model spread badge
  const spread = (hrrrRows.length && gfsRows.length) ? computeModelSpread(hrrrRows, gfsRows) : null;
  const spreadEl = document.getElementById('modelSpreadBadge');
  if (spread) {
    spreadEl.style.display = 'block';
    if (spread.highSpread) {
      spreadEl.style.background = 'rgba(255,184,48,0.08)';
      spreadEl.style.border = '1px solid rgba(255,184,48,0.25)';
      spreadEl.style.color = 'var(--warn)';
      spreadEl.innerHTML = `‚ö† <strong>High model spread at +1h:</strong> HRRR ${spread.hrrrPlus1.spd} kts ${degToCompass(spread.hrrrPlus1.dir)} vs GFS ${spread.gfsPlus1.spd} kts ${degToCompass(spread.gfsPlus1.dir)} ¬∑ Œîspd=${spread.spdSpread.toFixed(1)} kts ¬∑ Œîdir=${spread.dirSpread.toFixed(0)}¬∞ ‚Äî prediction confidence reduced.`;
    } else {
      spreadEl.style.background = 'rgba(57,255,140,0.05)';
      spreadEl.style.border = '1px solid rgba(57,255,140,0.15)';
      spreadEl.style.color = 'var(--accent3)';
      spreadEl.innerHTML = `‚úì <strong>Models agree at +1h:</strong> HRRR ${spread.hrrrPlus1.spd} kts vs GFS ${spread.gfsPlus1.spd} kts ¬∑ Œîspd=${spread.spdSpread.toFixed(1)} kts ¬∑ Œîdir=${spread.dirSpread.toFixed(0)}¬∞ ‚Äî higher confidence.`;
    }
  }

  // Blend note
  const plusOne = displayRows.find((r, i) => i === (hrrrRows.length ? 4 : 1)); // +60min
  if (plusOne) {
    const note = document.getElementById('meteoBlendNote');
    note.style.display = 'block';
    note.innerHTML = `<strong style="color:${primaryColor}">Model signal at +60min (${primaryModel}):</strong> ${degToCompass(plusOne.dir)} ${plusOne.spd} kts ¬∑ gust ${plusOne.gust} kts ‚Äî blended into ensemble at 20% weight. ${spread && spread.highSpread ? '<strong style="color:var(--warn)">High spread detected ‚Äî ensemble confidence reduced 10%.</strong>' : 'Models agree ‚Äî normal confidence.'}`;
  }
}

function getModelPlusSixty() {
  if (!modelForecastData || !modelForecastData.length) return null;
  // HRRR: index 4 = +60min (4 √ó 15min); GFS: index 1 = +60min (1 √ó 60min)
  const isHRRR = modelForecastData[0] && modelForecastData[0].model === 'HRRR';
  return modelForecastData[isHRRR ? 4 : 1] || modelForecastData[modelForecastData.length - 1];
}

/**
 * Returns model spread penalty for confidence (0 to -10).
 */
function getModelSpreadPenalty() {
  if (!modelForecastData || !gfsForecastData) return 0;
  const isHRRR = modelForecastData[0] && modelForecastData[0].model === 'HRRR';
  const spread = computeModelSpread(
    isHRRR ? modelForecastData : [],
    gfsForecastData
  );
  if (!spread) return 0;
  return spread.highSpread ? -10 : 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATION NETWORK ENGINE
//  Live observations from on-course and upstream
//  weather stations. NWS ASOS (CORS native) +
//  NDBC C-MAN CNII2 Northerly Island (CORS native).
//  No proxy needed for any of these sources.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// User-configurable: set to your GitHub Pages URL
// e.g. 'https://YOUR-USERNAME.github.io/crib-wind'
const ARCHIVE_BASE_URL = 'https://edwardkmui.github.io/crib-wind';   // ‚Üê FILL IN after deploying JSON to GitHub Pages

// Station store ‚Äî populated by fetchStationNetwork()
let stationData = {};

/**
 * Parse NDBC standard meteorological text file (CNII2).
 * Returns { dir, spdKts, gustKts, tempC, dewC, wvht, time } or null.
 */
function parseNDBCText(text) {
  const lines = text.trim().split('\n');
  // Find first data line (skip # header lines)
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith('#')) continue;
    const parts = lines[i].trim().split(/\s+/);
    if (parts.length < 10) continue;
    // Columns: YY MM DD hh mm WDIR WSPD GST WVHT DPD APD MWD PRES ATMP WTMP DEWP
    const dir    = parts[5]  === 'MM' ? null : parseInt(parts[5]);
    const wspd   = parts[6]  === 'MM' ? null : parseFloat(parts[6]);
    const gst    = parts[7]  === 'MM' ? null : parseFloat(parts[7]);
    const wvht   = parts[8]  === 'MM' ? null : parseFloat(parts[8]);
    const atmp   = parts[13] === 'MM' ? null : parseFloat(parts[13]);
    const wtmp   = parts[14] === 'MM' ? null : parseFloat(parts[14]);
    const dewp   = parts[15] === 'MM' ? null : parseFloat(parts[15]);
    return {
      dir,
      spdKts: wspd !== null ? wspd * 1.94384 : null,
      gustKts: gst !== null ? gst * 1.94384 : null,
      tempC:  atmp,
      waterTempC: wtmp,
      dewC:   dewp,
      wvht,
      time: `${parts[3]}:${parts[4]} UTC`
    };
  }
  return null;
}

/**
 * Parse NWS API observation JSON.
 * Returns { dir, spdKts, gustKts, tempC, dewC } or null.
 */
function parseNWSObs(json) {
  const p = json.properties;
  if (!p) return null;
  return {
    dir:     p.windDirection?.value ?? null,
    spdKts:  p.windSpeed?.value   != null ? p.windSpeed.value   * 1.94384 : null,
    gustKts: p.windGust?.value    != null ? p.windGust.value    * 1.94384 : null,
    tempC:   p.temperature?.value ?? null,
    dewC:    p.dewpoint?.value    ?? null,
    desc:    p.textDescription    ?? ''
  };
}

/**
 * Fetch all station data in parallel. Updates global stationData.
 */
async function fetchStationNetwork() {
  const fetches = await Promise.allSettled([
    fetchWithTimeout(getTodayUrl() + '?source=cnii2', {}, 8000)
      .then(r => r.text()).then(t => ({ id: 'CNII2', raw: t, type: 'ndbc' })),
    fetchWithTimeout('https://api.weather.gov/stations/KORD/observations/latest',
      { headers: { 'User-Agent': 'CribWindDashboard/1.0' } }, 8000)
      .then(r => r.json()).then(j => ({ id: 'KORD', raw: j, type: 'nws' })),
    fetchWithTimeout('https://api.weather.gov/stations/KMDW/observations/latest',
      { headers: { 'User-Agent': 'CribWindDashboard/1.0' } }, 8000)
      .then(r => r.json()).then(j => ({ id: 'KMDW', raw: j, type: 'nws' })),
    fetchWithTimeout('https://api.weather.gov/stations/KGYY/observations/latest',
      { headers: { 'User-Agent': 'CribWindDashboard/1.0' } }, 8000)
      .then(r => r.json()).then(j => ({ id: 'KGYY', raw: j, type: 'nws' })),
  ]);

  stationData = {};
  for (const result of fetches) {
    if (result.status !== 'fulfilled') continue;
    const { id, raw, type } = result.value;
    const parsed = type === 'ndbc' ? parseNDBCText(raw) : parseNWSObs(raw);
    if (parsed) stationData[id] = parsed;
  }
  return stationData;
}

/**
 * Compute Lake Breeze Index from live station data.
 * Primary driver: land-water temperature differential.
 * Secondary: wind direction backing toward NE/E, light onshore flow.
 * Returns { index 0‚Äì100, label, note }
 */
function computeLakeBreezeIndex(stations, cribbData, hourCST) {
  const sp = getSeasonalProfile();
  const seasonalBase = (sp.lakeBreezeProbByHour || Array(24).fill(0))[hourCST] || 0;

  // If it's not the season or not daytime, lake breeze is impossible
  if (hourCST < 9 || hourCST > 20) {
    return { index: 0, label: 'NOT ACTIVE', note: 'Lake breeze is a daytime phenomenon (10:00‚Äì19:00 CST).' };
  }
  if (seasonalBase < 5) {
    return { index: 0, label: 'SEASON LOW', note: `${sp.name}: lake breeze climatology is low this month.` };
  }

  let score = seasonalBase; // start from climatology

  // Crib air temp vs KORD (land) temp differential
  // Crib CNII2 gives air temp; KORD gives land temp
  const cnii2 = stations['CNII2'];
  const kord   = stations['KORD'];
  if (cnii2?.tempC != null && kord?.tempC != null) {
    const diff = kord.tempC - cnii2.tempC; // land hotter than water = lake breeze driver
    if (diff > 12) score += 30;
    else if (diff > 8)  score += 20;
    else if (diff > 5)  score += 12;
    else if (diff > 2)  score += 5;
    else if (diff < 0)  score -= 10; // lake warmer than land: no breeze
  }

  // Current Crib wind ‚Äî light S/SW/SE = favorable for lake breeze onset
  if (cribbData && cribbData.length > 0) {
    const latest = cribbData[cribbData.length - 1];
    const dir = degToCompass(latest.dir);
    if (['S','SSW','SW','SSE','SE'].includes(dir) && latest.spdKts < 10) score += 10;
    if (latest.spdKts > 15) score -= 20; // strong synoptic wind suppresses lake breeze
    if (['NE','NNE','E','ENE'].includes(dir)) score += 5; // already in NE flow = partial lb
  }

  // KORD vs KMDW comparison ‚Äî land pressure gradient
  if (kord?.spdKts != null && stations['KMDW']?.spdKts != null) {
    const landSpd = (kord.spdKts + stations['KMDW'].spdKts) / 2;
    if (landSpd < 8) score += 5; // light synoptic flow favors lake breeze development
    if (landSpd > 18) score -= 15;
  }

  score = Math.min(98, Math.max(0, Math.round(score)));

  let label, note;
  if (score >= 70) {
    label = 'HIGH';
    const diff = kord && cnii2 ? (kord.tempC - cnii2.tempC).toFixed(0) : '?';
    note = `Strong thermal gradient (land ${diff > 0 ? '+' : ''}${diff}¬∞C vs water). Lake breeze likely to fire ‚Äî watch for NE fill from the right side, possibly within 30‚Äì90 min. Get to starboard.`;
  } else if (score >= 45) {
    label = 'MODERATE';
    note = `Thermal conditions support lake breeze development. Watch for chop line ~0.5‚Äì1.5 nm offshore. If it crosses, NE fill will be quick.`;
  } else if (score >= 20) {
    label = 'LOW';
    note = `Some lake breeze potential but synoptic flow or temperature differential is limiting. Unlikely to fire strongly today.`;
  } else {
    label = 'NEGLIGIBLE';
    note = `Conditions don't favor lake breeze. Synoptic wind or season is dominant.`;
  }

  return { index: score, label, note };
}

/**
 * Compute upstream pressure signal ‚Äî what's coming from land stations.
 * Returns { signal: 'building'|'fading'|'stable'|'shifting', spdDiff, dirDiff, note }
 */
function computeUpstreamSignal(stations, cribLatest) {
  if (!cribLatest) return null;
  const cribSpd = cribLatest.spdKts;
  const cribDir = cribLatest.dir;

  // Weight upstream stations by relevance to current wind direction
  const cribComp = degToCompass(cribDir);
  let upstreamSpd = null, upstreamDir = null, upstreamName = '';

  // Pick the most relevant upstream station
  if (['W','WNW','NW','NNW','SW','WSW'].includes(cribComp)) {
    const kord = stations['KORD'];
    if (kord?.spdKts != null) {
      upstreamSpd = kord.spdKts;
      upstreamDir = kord.dir;
      upstreamName = 'KORD (O\'Hare)';
    }
  } else if (['S','SSW','SSE','SE'].includes(cribComp)) {
    const kgyy = stations['KGYY'];
    if (kgyy?.spdKts != null) {
      upstreamSpd = kgyy.spdKts;
      upstreamDir = kgyy.dir;
      upstreamName = 'KGYY (Gary)';
    }
  } else if (['NE','N','NNE','E','ENE'].includes(cribComp)) {
    const cnii2 = stations['CNII2'];
    if (cnii2?.spdKts != null) {
      upstreamSpd = cnii2.spdKts;
      upstreamDir = cnii2.dir;
      upstreamName = 'CNII2 (Northerly Island)';
    }
  }

  if (upstreamSpd === null) return null;

  const spdDiff = upstreamSpd - cribSpd;
  const dirDiff = upstreamDir != null ? circDiff(cribDir, upstreamDir) : 0;
  let signal = 'stable', note = '';

  if (Math.abs(spdDiff) <= 2 && Math.abs(dirDiff) <= 15) {
    signal = 'stable';
    note = `${upstreamName} agrees with Crib ‚Äî conditions consistent, no change expected from this direction.`;
  } else if (spdDiff > 4) {
    signal = 'building';
    note = `${upstreamName} showing ${upstreamSpd.toFixed(0)} kts vs Crib ${cribSpd.toFixed(0)} kts ‚Äî stronger wind upstream. Expect building conditions in the next 20‚Äì40 min.`;
  } else if (spdDiff < -4) {
    signal = 'fading';
    note = `${upstreamName} lighter (${upstreamSpd.toFixed(0)} kts) than Crib (${cribSpd.toFixed(0)} kts) ‚Äî wind may ease on the course soon.`;
  } else if (Math.abs(dirDiff) > 20) {
    signal = 'shifting';
    note = `${upstreamName} direction ${degToCompass(upstreamDir)} vs Crib ${degToCompass(cribDir)} ‚Äî wind shift propagating toward the course.`;
  }

  return { signal, spdDiff, dirDiff, upstreamSpd, upstreamDir, upstreamName, note };
}

// Global upstream signal ‚Äî used by strategy engine
let upstreamSignalData = null;

/**
 * Render station network panel.
 */
function renderStationNetwork(stations, cribData) {
  const cribLatest = cribData && cribData.length > 0 ? cribData[cribData.length - 1] : null;
  const now = new Date();
  const hourCST = parseInt(new Intl.DateTimeFormat('en-US',{hour:'numeric',hour12:false,timeZone:'America/Chicago'}).format(now)) % 24;

  document.getElementById('stationNetworkUpdated').textContent =
    `Updated ${now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', timeZone:'America/Chicago' })} CST`;

  // Render each card
  const cards = [
    { id: 'CNII2', data: stations['CNII2'] },
    { id: 'KORD',  data: stations['KORD']  },
    { id: 'KMDW',  data: stations['KMDW']  },
    { id: 'KGYY',  data: stations['KGYY']  },
  ];

  cards.forEach(({ id, data }) => {
    const card = document.getElementById(`stCard-${id}`);
    if (!card) return;
    card.classList.remove('loading');

    if (!data || data.spdKts == null) {
      document.getElementById(`stArrow-${id}`).textContent = '‚Äî';
      document.getElementById(`stSpd-${id}`).textContent = '‚Äî';
      document.getElementById(`stDir-${id}`).textContent = 'No data';
      document.getElementById(`stGust-${id}`).textContent = '';
      document.getElementById(`stTemp-${id}`).textContent = '';
      document.getElementById(`stDelta-${id}`).innerHTML =
        `<span class="station-status error"></span>Unavailable`;
      return;
    }

    const spdStr   = data.spdKts.toFixed(1);
    const dirStr   = data.dir != null ? `${degToCompass(data.dir)} ${data.dir}¬∞` : '‚Äî';
    const arrow    = data.dir != null ? dirArrow(data.dir) : '‚Äî';

    document.getElementById(`stArrow-${id}`).textContent = arrow;
    document.getElementById(`stSpd-${id}`).textContent = spdStr;
    document.getElementById(`stDir-${id}`).textContent = dirStr;

    if (data.gustKts != null) {
      document.getElementById(`stGust-${id}`).textContent =
        `Gust: ${data.gustKts.toFixed(1)} kts`;
    }

    const tempParts = [];
    if (data.tempC != null) {
      const f = (data.tempC * 9/5 + 32).toFixed(0);
      tempParts.push(`Air: ${data.tempC.toFixed(1)}¬∞C (${f}¬∞F)`);
    }
    if (data.waterTempC != null) {
      const f = (data.waterTempC * 9/5 + 32).toFixed(0);
      tempParts.push(`Water: ${data.waterTempC.toFixed(1)}¬∞C (${f}¬∞F)`);
    }
    document.getElementById(`stTemp-${id}`).textContent = tempParts.join(' ¬∑ ');

    // Delta vs Crib
    const deltaEl = document.getElementById(`stDelta-${id}`);
    if (cribLatest && id !== 'CNII2') {
      const spdD = data.spdKts - cribLatest.spdKts;
      const dirD = data.dir != null ? circDiff(cribLatest.dir, data.dir) : null;
      const spdSign = spdD >= 0 ? '+' : '';
      const dirSign = dirD >= 0 ? '+' : '';
      const spdCls = Math.abs(spdD) > 3 ? (spdD > 0 ? 'delta-up' : 'delta-down') : '';
      deltaEl.innerHTML =
        `<span class="station-status live"></span>` +
        `vs Crib: <span class="${spdCls}">${spdSign}${spdD.toFixed(1)} kts</span>` +
        (dirD != null ? ` ¬∑ dir ${dirSign}${dirD.toFixed(0)}¬∞` : '');
    } else {
      deltaEl.innerHTML = `<span class="station-status live"></span>On-course reference`;
    }
  });

  // Lake breeze index
  const lb = computeLakeBreezeIndex(stations, cribData, hourCST);
  const lbBar = document.getElementById('lbIndexBar');
  const lbVal = document.getElementById('lbIndexVal');
  const lbNote = document.getElementById('lbIndexNote');
  if (lbBar) {
    lbBar.style.width = lb.index + '%';
    const col = lb.index >= 70 ? 'var(--danger)' : lb.index >= 45 ? 'var(--warn)' : 'var(--accent3)';
    lbBar.style.background = col;
  }
  if (lbVal) {
    lbVal.textContent = `${lb.index}% ¬∑ ${lb.label}`;
    lbVal.style.color = lb.index >= 70 ? 'var(--danger)' : lb.index >= 45 ? 'var(--warn)' : 'var(--accent3)';
  }
  if (lbNote) lbNote.textContent = lb.note;

  // Compute + cache upstream signal for strategy engine
  upstreamSignalData = computeUpstreamSignal(stations, cribLatest);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARCHIVE PATTERN MATCH ENGINE
//  Fetches crib_patterns.json and crib_seasonal.json
//  from GitHub Pages. Finds the most similar historical
//  hour and blends its outcome into the prediction.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let archivePatterns  = null;
let archiveSeasonal  = null;
let archiveSignal    = null; // { predSpd, predDir, confidence, matchScore, matchLabel }

async function fetchArchivePatterns() {
  if (!ARCHIVE_BASE_URL) return; // not configured
  try {
    const [pRes, sRes] = await Promise.all([
      fetch(`${ARCHIVE_BASE_URL}/crib_patterns.json`),
      fetch(`${ARCHIVE_BASE_URL}/crib_seasonal.json`),
    ]);
    if (pRes.ok) archivePatterns = await pRes.json();
    if (sRes.ok) archiveSeasonal = await sRes.json();
    // Activate the chip
    const chip = document.getElementById('chip-archive');
    if (chip && archivePatterns) chip.classList.add('active');
  } catch (e) {
    console.warn('Archive fetch failed:', e.message);
  }
}

/**
 * Find the best matching historical pattern for current conditions.
 * Returns { predSpd, predDir, confidence, matchScore, nMatches, label } or null.
 */
function encodeArchiveKey(month, dirDeg, spdKts, hourCST) {
  const octant = Math.round(((dirDeg % 360) + 360) % 360 / 45) % 8;
  const band   = spdKts < 5 ? 0 : spdKts < 10 ? 1 : spdKts < 15 ? 2 : spdKts < 20 ? 3 : spdKts < 25 ? 4 : 5;
  const hBlock = Math.floor(((hourCST % 24) + 24) % 24 / 3);
  return `${month}_${octant}_${band}_${hBlock}`;
}

function matchArchivePattern(cribData) {
  if (!archivePatterns || typeof archivePatterns !== 'object') return null;
  if (!cribData || cribData.length < 10) return null;

  const latest  = cribData[cribData.length - 1];
  const now     = new Date();
  const month   = now.getMonth() + 1;
  const hourCST = parseInt(new Intl.DateTimeFormat('en-US',{hour:'numeric',hour12:false,timeZone:'America/Chicago'}).format(now)) % 24;
  const octant  = Math.round(((latest.dir % 360) + 360) % 360 / 45) % 8;
  const band    = latest.spdKts < 5 ? 0 : latest.spdKts < 10 ? 1 : latest.spdKts < 15 ? 2 :
                  latest.spdKts < 20 ? 3 : latest.spdKts < 25 ? 4 : 5;
  const hBlock  = Math.floor(hourCST / 3);
  const prevMon = month === 1 ? 12 : month - 1;
  const nextMon = month === 12 ? 1 : month + 1;

  const exactKey = `${month}_${octant}_${band}_${hBlock}`;
  const candidateKeys = [
    exactKey,
    `${prevMon}_${octant}_${band}_${hBlock}`,
    `${nextMon}_${octant}_${band}_${hBlock}`,
    band > 0 ? `${month}_${octant}_${band-1}_${hBlock}` : null,
    band < 5 ? `${month}_${octant}_${band+1}_${hBlock}` : null,
    `${month}_${(octant+1)%8}_${band}_${hBlock}`,
    `${month}_${(octant+7)%8}_${band}_${hBlock}`,
  ].filter(k => k && archivePatterns[k]);

  if (candidateKeys.length === 0) return null;

  const exactEntry = archivePatterns[exactKey] || null;
  let wSumSpd = 0, wSumSin = 0, wSumCos = 0, wTotal = 0;
  candidateKeys.forEach(key => {
    const e = archivePatterns[key];
    if (!e) return;
    const w = (key === exactKey ? 1.0 : 0.35) * Math.sqrt(e.n || 1);
    wSumSpd += w * (e.p60_spd_mean || 0);
    const rad = (e.p60_dir_mean || latest.dir) * Math.PI / 180;
    wSumSin += w * Math.sin(rad);
    wSumCos += w * Math.cos(rad);
    wTotal  += w;
  });

  if (wTotal === 0) return null;

  const predSpd = wSumSpd / wTotal;
  let predDir = Math.atan2(wSumSin / wTotal, wSumCos / wTotal) * 180 / Math.PI;
  predDir = ((predDir % 360) + 360) % 360;

  const n    = exactEntry ? (exactEntry.n || 0) : 0;
  const conf = exactEntry ? (exactEntry.base_confidence || 55) : 45;
  const label = n > 200 ? 'Strong' : n > 50 ? 'Moderate' : 'Weak';

  archiveSignal = { predSpd, predDir, matchConf: conf, matchScore: n,
                    nMatches: candidateKeys.length, label, key: exactKey, entry: exactEntry };
  return archiveSignal;
}

function getArchiveSignalWeight() {
  if (!archiveSignal || !archiveSignal.entry) return 0;
  const n = archiveSignal.matchScore;
  if (n > 200) return 0.12;
  if (n > 50)  return 0.08;
  if (n > 10)  return 0.04;
  return 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RACE STRATEGY ENGINE
//  Windward-leeward one-design buoy race, Chicago
//  lakefront. Synthesizes all available signals into
//  actionable tactical advice.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Determine left/right/split bias from wind direction and predicted shift.
 * On a W-L course the windward mark is directly upwind.
 * Left = port tack favored, Right = starboard tack favored.
 *
 * Chicago-specific rules:
 * - SW/W/NW: right (starboard) favored ‚Äî pressure builds from the west shore,
 *   oscillating shifts are typically larger to the right
 * - S/SSW: left (port) favored ‚Äî southerly lifts port tack toward the mark,
 *   lake breeze often fills from right later (timing matters)
 * - NE/E (lake breeze): right (starboard) strongly favored ‚Äî breeze fills from
 *   the east/right side first, stay with the new breeze
 * - N/NW post-frontal: right favored ‚Äî pressure line comes from NW
 * - Veering (clockwise): favors starboard (right)
 * - Backing (counter-clockwise): favors port (left)
 */
function computeSideBias(currentDir, predDir30, predDir60, dirOscil, sp, hourCST) {
  const dir = degToCompass(currentDir);
  const shift30 = circDiff(currentDir, predDir30); // + = veer, - = back
  const shift60 = circDiff(currentDir, predDir60);

  // Lake breeze probability this hour
  const lbProb = (sp.lakeBreezeProbByHour || Array(24).fill(0))[hourCST] || 0;

  let bias = 0;    // + = right, - = left, magnitude = confidence
  let reasons = [];

  // 1. Current direction bias (Chicago-specific)
  if (['W','WNW','NW','NNW'].includes(dir)) {
    bias += 2; reasons.push('W/NW winds: pressure typically builds right side first');
  } else if (['SW','WSW'].includes(dir)) {
    bias += 1; reasons.push('SW flow: slight right bias, watch for oscillations');
  } else if (['S','SSW','SSE'].includes(dir)) {
    bias -= 2; reasons.push('Southerly: port tack lifted toward mark, go left');
  } else if (['SE','E','ENE'].includes(dir)) {
    bias -= 1; reasons.push('SE/E: port tack favored, breeze may back further');
  } else if (['NE','NNE'].includes(dir)) {
    bias += 3; reasons.push('NE lake breeze: stay right ‚Äî breeze fills from starboard side');
  } else if (['N'].includes(dir)) {
    bias += 1; reasons.push('N wind: slight right bias from lake effect');
  }

  // 2. Predicted shift direction
  if (shift30 > 8) {
    bias += 2; reasons.push(`Wind veering ${shift30.toFixed(0)}¬∞ in 30 min ‚Äî starboard (right) tack gains lift`);
  } else if (shift30 < -8) {
    bias -= 2; reasons.push(`Wind backing ${Math.abs(shift30).toFixed(0)}¬∞ in 30 min ‚Äî port (left) tack gains lift`);
  }

  // 3. Lake breeze transition
  if (lbProb > 40 && ['S','SSW','SW','SSE','SE'].includes(dir)) {
    bias += 2;
    reasons.push(`${lbProb}% lake breeze probability ‚Äî NE fill incoming from right side`);
  }

  // 4. High oscillation: split the course
  if (dirOscil > 12) {
    reasons.push(`High oscillation ¬±${dirOscil.toFixed(0)}¬∞ ‚Äî don't over-commit, play shifts`);
  }

  const sideLabel = Math.abs(bias) >= 3 ? 'STRONGLY ' : Math.abs(bias) >= 2 ? '' : 'SLIGHT ';
  const side      = bias > 1 ? 'RIGHT' : bias < -1 ? 'LEFT' : 'SPLIT';
  const sideConf  = Math.min(90, Math.abs(bias) * 18 + 20);

  return { bias, side, sideLabel, sideConf, reasons, shift30, shift60, lbProb };
}

/**
 * Main strategy generator. Returns structured strategy object.
 */
function generateStrategy(data, predResult) {
  if (!data || data.length < 15 || !predResult) return null;

  const p       = predResult;
  const latest  = data[data.length - 1];
  const sp      = getSeasonalProfile();
  const now     = new Date();
  const hourCST = parseInt(new Intl.DateTimeFormat('en-US',{hour:'numeric',hour12:false,timeZone:'America/Chicago'}).format(now)) % 24;
  const dir     = degToCompass(latest.dir);
  const spd     = latest.spdKts;
  const gust    = latest.gstKts;

  // Gather NWS shift data if available
  const nwsShift = nwsForecastData && nwsForecastData.find(p => p.hasShift);

  // Side bias
  const sb = computeSideBias(latest.dir, p.predDir30, p.predDir, p.dirOscil, sp, hourCST);

  // Wind conditions characterisation
  const isLightAir   = spd < 7;
  const isMedium     = spd >= 7 && spd < 14;
  const isHeavy      = spd >= 14;
  const isGusty      = p.avgGustRatio > 1.35;
  const isOscillating = p.dirOscil > 10;
  const isBuilding   = p.spdDelta30 > 1.5;
  const isFading     = p.spdDelta30 < -1.5;
  const isVeering    = sb.shift30 > 6;
  const isBacking    = sb.shift30 < -6;
  const lbFiring     = sb.lbProb > 45 && ['S','SSW','SW','SSE','SE'].includes(dir);
  const postFrontal  = ['NW','NNW','WNW','W'].includes(dir) && spd > 8;

  // ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ
  let dangerAlert = null;
  let warnAlert   = null;

  if (sp.thunderstormRisk === 'high' && hourCST >= 13 && hourCST <= 20) {
    dangerAlert = `‚õà SAFETY: ${sp.name} peak thunderstorm window (${hourCST}:00 CST). Monitor radar before and during racing. MCS squall lines can produce 40‚Äì60 kt winds with little warning. Have an escape plan.`;
  }
  if (nwsForecastData && nwsForecastData.some(p => p.hasAdvisory)) {
    dangerAlert = (dangerAlert || '') + (dangerAlert ? ' ' : '') + `‚ö† NWS Small Craft Advisory or Warning in effect for LMZ740‚Äì742. Review conditions carefully.`;
  }
  if (gust > 22) {
    warnAlert = `Gusting to ${gust.toFixed(0)} kts currently. Expect ${p.predGust30.toFixed(0)}‚Äì${p.predGust.toFixed(0)} kt gusts over the race. Reef decision: ${gust > 28 ? 'strongly consider reducing sail' : 'monitor ‚Äî may want to reef on longer races'}.`;
  }
  if (isLightAir) {
    warnAlert = (warnAlert || '') + (warnAlert ? ' ' : '') + `Light air (${spd.toFixed(1)} kts) ‚Äî patience required. Avoid tacking in holes.`;
  }

  // ‚îÄ‚îÄ START LINE ‚îÄ‚îÄ
  const startBullets = [];
  if (sb.side === 'RIGHT') {
    startBullets.push(`Starboard end (pin end) favored ‚Äî line up for a starboard tack start near the pin to access the right side immediately`);
    startBullets.push(`Look for boats stacking at committee boat ‚Äî pressure on pin, may be less crowded`);
  } else if (sb.side === 'LEFT') {
    startBullets.push(`Port end (committee boat) favored ‚Äî position for a starboard start near the committee boat to immediately tack to port`);
    startBullets.push(`Early port tack flyer is valid if the left shift materializes before the gun`);
  } else {
    startBullets.push(`Course is relatively square ‚Äî start near mid-line and look for first puff to commit to a side`);
    startBullets.push(`Avoid the laylines early ‚Äî keep options open in the first 2‚Äì3 minutes`);
  }
  if (isGusty) startBullets.push(`Gusty conditions: start with speed rather than position ‚Äî a slow start in a gust is hard to recover`);
  if (isLightAir) startBullets.push(`Light air: avoid barging, protect your lane, don't get caught in bad air near the line`);
  if (isHeavy) startBullets.push(`Heavy air: time your approach carefully, a late run-in with speed beats a slow early start`);

  // ‚îÄ‚îÄ UPWIND ‚îÄ‚îÄ
  const upwindBullets = [];
  if (sb.side === 'RIGHT') {
    upwindBullets.push(`Prioritize the right side ‚Äî sail to the starboard layline before tacking back`);
    if (isVeering) upwindBullets.push(`Wind veering: each lift on starboard is real ‚Äî don't tack on headers, wait for the lift to max out`);
  } else if (sb.side === 'LEFT') {
    upwindBullets.push(`Get to the left side early ‚Äî tack to port as soon as you have clear air off the start`);
    if (isBacking) upwindBullets.push(`Wind backing: each lift on port is real ‚Äî hold your port tack until headers come`);
  } else {
    upwindBullets.push(`Play the oscillating shifts: tack on headers, lift on your current tack`);
    upwindBullets.push(`Current oscillation ¬±${p.dirOscil.toFixed(0)}¬∞ ‚Äî shifts are approximately ${sp.shiftFreqPerHr > 1.5 ? 'frequent (~' + sp.shiftFreqPerHr + '/hr)' : 'moderate'}`);
  }
  if (lbFiring) upwindBullets.push(`Lake breeze filling from right (NE) ‚Äî if you see chop line offshore, get to starboard tack immediately`);
  if (isBuilding) upwindBullets.push(`Breeze building (+${p.spdDelta30.toFixed(1)} kts predicted at +30 min) ‚Äî upwind boat speed will increase through the leg`);
  if (isFading) upwindBullets.push(`Breeze fading (${p.spdDelta30.toFixed(1)} kts predicted at +30 min) ‚Äî extend on the favored tack now before conditions deteriorate`);
  if (postFrontal) upwindBullets.push(`Post-frontal NW flow: expect pressure lines ‚Äî sail in the darker water (more pressure), avoid lighter patches`);
  if (nwsShift) upwindBullets.push(`NWS forecast: wind ${nwsShift.windDir} becoming ${nwsShift.shiftDir} ‚Äî plan your approach to the windward mark around this transition`);

  // ‚îÄ‚îÄ DOWNWIND ‚îÄ‚îÄ
  const downwindBullets = [];
  const downwindDir = ((latest.dir + 180) % 360); // approximate running direction
  const ddComp = degToCompass(downwindDir);

  if (['W','NW','WNW','SW','NNW'].includes(dir)) {
    downwindBullets.push(`W/NW running: gybe set to starboard, stay on port jibe initially to build speed, gybe in the shifts`);
    downwindBullets.push(`Look for pressure on the right side of the run ‚Äî puffs fill from the west, sail toward them`);
  } else if (['S','SSW','SSE','SE'].includes(dir)) {
    downwindBullets.push(`Southerly running: jibe angle is key ‚Äî sail hot to maintain VMG, avoid a deep run in light/fading air`);
    if (lbFiring) downwindBullets.push(`Lake breeze transition on the run is dangerous ‚Äî if the NE fills, your angle changes dramatically, stay ready to gybe`);
  } else if (['NE','E','ENE'].includes(dir)) {
    downwindBullets.push(`NE running: go low on starboard jibe (left side of run) to get into pressure; come back right to avoid leeward boat pile-up at the mark`);
  }
  if (isGusty) downwindBullets.push(`Gusty: surf the puffs ‚Äî don't fight to stay high, let the boat run in the gusts`);
  if (isHeavy) downwindBullets.push(`Heavy air run: keep crew weight aft, gybe early before the leeward mark to avoid the crash-gybe pile-up`);
  if (isLightAir) downwindBullets.push(`Light air: stay high of thumb line, maximize apparent wind, gybe in the pressure`);

  // ‚îÄ‚îÄ WATCH FOR ‚îÄ‚îÄ
  const watchBullets = [];
  watchBullets.push(`Next refresh in ~5 min ‚Äî direction predicted ${sb.shift30 > 0 ? 'veering +' : ''}${sb.shift30.toFixed(0)}¬∞ over next 30 min`);
  if (sp.thunderstormRisk === 'high') watchBullets.push(`Afternoon convection: keep one eye on the western horizon from about ${Math.max(13, hourCST + 1)}:00 CST onward`);
  if (lbFiring || sb.lbProb > 25) watchBullets.push(`Lake breeze front: look for a chop line and wind shadow ~0.5‚Äì2 nm offshore ‚Äî when the front crosses, NE fills quickly`);
  if (isOscillating) watchBullets.push(`High oscillation: watch compass obsessively upwind, tack on every 10¬∞+ header`);
  if (p.conf <= 40) watchBullets.push(`Low prediction confidence (${p.conf}%) ‚Äî conditions are hard to forecast, stay flexible and avoid long commitments to either side`);
  if (postFrontal) watchBullets.push(`Post-frontal: watch for pressure lines visible as dark streaks on the water ‚Äî sail into them`);
  if (isGusty && sp.thunderstormRisk !== 'low') watchBullets.push(`Gust ratio ${p.avgGustRatio.toFixed(2)}x ‚Äî could indicate convective activity approaching`);
  watchBullets.push(`HRRR model at +60 min: ${degToCompass(p.predDir)} ${p.predSpd.toFixed(0)} kts ‚Äî gives picture of post-race conditions`);

  // ‚îÄ‚îÄ NARRATIVE ‚îÄ‚îÄ
  const conditionSummary = isHeavy ? `heavy air (${spd.toFixed(0)} kts, gusting ${gust.toFixed(0)})` :
                           isMedium ? `moderate breeze (${spd.toFixed(0)} kts)` :
                           `light air (${spd.toFixed(0)} kts)`;

  const shiftSummary = Math.abs(sb.shift30) > 6
    ? `The wind is ${sb.shift30 > 0 ? 'veering clockwise' : 'backing counter-clockwise'}, predicted to shift ${Math.abs(sb.shift30).toFixed(0)}¬∞ over the next 30 minutes.`
    : `Direction is relatively stable ‚Äî oscillating ¬±${p.dirOscil.toFixed(0)}¬∞ around ${dir}.`;

  const lakeBreezeNote = lbFiring
    ? ` <em>Lake breeze transition likely this race</em> ‚Äî the thermal gradient is strong enough to fire a NE fill, which will completely reset the playing field. Get to the right side before it arrives.`
    : sb.lbProb > 20
    ? ` Lake breeze probability is ${sb.lbProb}% this hour ‚Äî possible but not certain. Watch the offshore chop line.`
    : '';

  const narrative = `
    Current conditions: <strong>${dir} at ${spd.toFixed(1)} kts, gusting ${gust.toFixed(1)} kts</strong> ‚Äî ${conditionSummary}.
    ${shiftSummary}${lakeBreezeNote}
    <br><br>
    <strong>Primary call: ${sb.sideLabel}${sb.side === 'SPLIT' ? 'SPLIT THE COURSE' : sb.side + ' SIDE'}.</strong>
    ${sb.reasons.slice(0, 2).join('. ')}.
    ${nwsShift ? `NWS human forecaster shows wind becoming <strong>${nwsShift.shiftDir}</strong> during ${nwsShift.name} ‚Äî factor this into your mark approach.` : ''}
    <br><br>
    At 30 minutes the HRRR model and statistical ensemble agree the wind will be
    <strong>${degToCompass(p.predDir30)} at ${p.predSpd30.toFixed(1)} kts</strong>
    (confidence: ${p.conf30}%).
    At 60 minutes: <strong>${degToCompass(p.predDir)} at ${p.predSpd.toFixed(1)} kts</strong>
    (confidence: ${p.conf}%).
    ${p.conf30 - p.conf > 8 ? `The drop in confidence from 30 to 60 minutes is significant ‚Äî <em>prioritize the 30-min prediction for race decisions.</em>` : ''}
  `.trim();

  return {
    side: sb.side, sideLabel: sb.sideLabel, sideConf: sb.sideConf,
    sideReasons: sb.reasons,
    dangerAlert, warnAlert,
    startBullets, upwindBullets, downwindBullets, watchBullets,
    narrative,
    conf: p.conf, confLevel: p.confLevel, confColor: p.confColor
  };
}

function renderStrategy(data, predResult) {
  const panel = document.getElementById('strategyPanel');
  const s = generateStrategy(data, predResult);
  if (!s) { panel.style.display = 'none'; return; }

  panel.style.display = 'block';

  // Meta
  const now = new Date();
  document.getElementById('strategyMeta').textContent =
    `W-L one-design ¬∑ Chicago lakefront ¬∑ ${now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'})} CST`;

  // Confidence pip
  document.getElementById('strategyConfPip').style.background = s.confColor;
  document.getElementById('strategyConfLabel').textContent = `${s.confLevel} confidence`;
  document.getElementById('strategyConfLabel').style.color = s.confColor;

  // Alerts
  const dangerEl = document.getElementById('strategyDangerAlert');
  const warnEl   = document.getElementById('strategyWarnAlert');
  if (s.dangerAlert) { dangerEl.style.display = 'block'; dangerEl.innerHTML = s.dangerAlert; }
  else dangerEl.style.display = 'none';
  if (s.warnAlert) { warnEl.style.display = 'block'; warnEl.innerHTML = s.warnAlert; }
  else warnEl.style.display = 'none';

  // Side call
  const sideIcon  = s.side === 'RIGHT' ? '‚Üí' : s.side === 'LEFT' ? '‚Üê' : '‚Üî';
  const sideClass = s.side === 'RIGHT' ? 'favored' : s.side === 'LEFT' ? 'favored' : 'split';
  const avoidSide = s.side === 'RIGHT' ? 'LEFT' : s.side === 'LEFT' ? 'RIGHT' : '‚Äî';

  document.getElementById('strategySideCall').innerHTML = `
    <div class="side-card ${sideClass}">
      <div class="side-icon">${sideIcon}</div>
      <div>
        <div class="side-label">Favored Side</div>
        <div class="side-name">${s.side === 'SPLIT' ? 'SPLIT' : s.side + ' SIDE'}</div>
        <div class="side-reason">${s.sideReasons.slice(0,2).join(' ¬∑ ')}</div>
      </div>
    </div>
    ${s.side !== 'SPLIT' ? `
    <div class="side-card avoid" style="max-width:180px;">
      <div>
        <div class="side-label">Avoid / Secondary</div>
        <div class="side-name" style="font-size:16px;color:var(--muted);">${avoidSide}</div>
        <div class="side-reason">Unless significant shift materializes</div>
      </div>
    </div>` : ''}
  `;

  // Bullets helper
  function renderBullets(id, bullets, warnIdxs = [], dangerIdxs = []) {
    document.getElementById(id).innerHTML = bullets.map((b, i) => {
      const cls = dangerIdxs.includes(i) ? 'danger' : warnIdxs.includes(i) ? 'warn' : '';
      return `<li class="strategy-bullet ${cls}">${b}</li>`;
    }).join('');
  }
  renderBullets('strategyStart',    s.startBullets);
  renderBullets('strategyUpwind',   s.upwindBullets);
  renderBullets('strategyDownwind', s.downwindBullets);
  renderBullets('strategyWatch',    s.watchBullets, [0,1,2,3]);

  // Narrative
  document.getElementById('strategyNarrative').innerHTML = s.narrative;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEASONAL KNOWLEDGE ENGINE
//  Data synthesized from GLERL archive 2000‚Äì2025,
//  NOAA CoastWatch Great Lakes SST climatology,
//  NWS LMK marine zone historical records.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SEASONAL = {
  // month index 0=Jan ‚Ä¶ 11=Dec
  // Racing season = May(4) through Sep(8)
  profiles: {
    4: { // MAY
      name: 'May', emoji: 'üå±',
      tagline: 'Transitional ¬∑ frontal systems dominate ¬∑ cold lake suppresses convection',
      waterTempF: [45, 52], // [low, high] range ¬∞F
      waterTempMid: 48,
      dominantDirs: ['W','NW','SW'],
      avgSpdKts: [8, 14],
      lakeBreezeProbByHour: [0,0,0,0,0,0, 3,4,5,7,9,10, 12,14,12,10,8,6, 4,2,1,0,0,0],
      lakeBreezeSeason: 'early ‚Äî unreliable before late May',
      thunderstormRisk: 'low',
      shiftCharacter: 'moderate ‚Äî frontal passages every 4‚Äì6 days',
      racingNotes: [
        { icon:'üåä', condition:'Cold lake effect', text:'Lake at 45‚Äì52¬∞F stabilizes the air mass above it. S/SW gradient winds often feel lighter offshore than ashore ‚Äî the cold water chills the lower atmosphere and reduces vertical mixing. Don\'t trust the dock reading.' },
        { icon:'üåÄ', condition:'Frontal dominance', text:'W and NW post-frontal flow is the most reliable wind of May. Synoptic gradient drives everything. Lake breeze rarely fires before late May ‚Äî water too cold for meaningful land-sea differential.' },
        { icon:'‚ö†Ô∏è', condition:'Suppressed convection', text:'The cold lake suppresses thunderstorm development directly over the water, but squall lines crossing from Iowa/Wisconsin can arrive with little warning. Monitor radar upwind.' },
        { icon:'üéØ', condition:'Tactic: Starboard bias', text:'Post-frontal W/NW in May is your cleanest wind. Starboard tack favored in WNW flow due to geographic lift from the lake\'s fetch direction. Persistent pressure, good for long-leg races.' }
      ],
      confModifier: 0,   // adjustment to prediction confidence (%)
      confNote: 'May confidence is near-neutral. Synoptic flows are predictable; lake breeze variability is low this month.',
      shiftFreqPerHr: 0.8,
    },
    5: { // JUNE
      name: 'June', emoji: 'üå§Ô∏è',
      tagline: 'Lake breeze season opens ¬∑ 20‚Äì25¬∞F land-sea differential ¬∑ 30‚Äì50¬∞ shifts possible',
      waterTempF: [52, 65],
      waterTempMid: 58,
      dominantDirs: ['S','SW','NE'],
      avgSpdKts: [7, 13],
      lakeBreezeProbByHour: [0,0,0,0,0,0, 2,4,7,12,18,24, 30,34,32,28,20,12, 7,4,2,0,0,0],
      lakeBreezeSeason: 'opening ‚Äî fires 30‚Äì40% of sunny days',
      thunderstormRisk: 'moderate',
      shiftCharacter: 'high ‚Äî lake breeze transitions create 30‚Äì60¬∞ swings',
      racingNotes: [
        { icon:'üå¨Ô∏è', condition:'Lake breeze initiation', text:'June marks the real opening of lake breeze season. With land hitting 75‚Äì80¬∞F and the lake at 55‚Äì65¬∞F, you get 15‚Äì25¬∞F differential by noon ‚Äî enough to drive an onshore NE flow. Watch for the pressure line moving S from the north shore.' },
        { icon:'‚ö°', condition:'Gradient vs breeze battle', text:'Morning S/SW gradient wind and afternoon NE lake breeze can collide. The transition zone (convergence line) often sits 1‚Äì3 miles offshore and is visible as a chop line. On the windward side: puffs and oscillations. Once the breeze wins: steady NE.' },
        { icon:'üß≠', condition:'Direction: S‚ÜíNE rotation', text:'Classic June day: 7am SW at 8 kts ‚Üí 10am light and variable ‚Üí 12:30pm NE lake breeze fills from the right (true right on the course). This is the most tactically important shift of the season ‚Äî position yourself for it.' },
        { icon:'‚õµ', condition:'Tactic: Early right bias', text:'On NE lake breeze days, right side of course (looking upwind at the start) is favored ‚Äî the breeze fills from the right. Port tack lay line is often short. Be ready for the oscillation near the convergence zone.' }
      ],
      confModifier: -8,
      confNote: 'June confidence reduced: lake breeze onset timing is hard to predict statistically. ¬±45 min error on breeze arrival is common. Direction signals are less reliable during gradient-to-breeze transitions.',
      shiftFreqPerHr: 1.4,
    },
    6: { // JULY
      name: 'July', emoji: '‚òÄÔ∏è',
      tagline: 'Peak lake breeze season ¬∑ most direction changes of the year ¬∑ highest shift frequency',
      waterTempF: [62, 72],
      waterTempMid: 67,
      dominantDirs: ['NE','S','SW'],
      avgSpdKts: [6, 12],
      lakeBreezeProbByHour: [0,0,0,0,0,0, 2,4,8,16,26,36, 44,48,44,38,28,18, 10,5,2,0,0,0],
      lakeBreezeSeason: 'peak ‚Äî fires 55‚Äì65% of sunny days',
      thunderstormRisk: 'moderate-high',
      shiftCharacter: 'very high ‚Äî 90¬∞ shifts in <30 min documented',
      racingNotes: [
        { icon:'‚òÄÔ∏è', condition:'Most predictable pattern', text:'July is when the lake breeze is most reliable. Land temps routinely hit 85‚Äì90¬∞F while the lake holds 65‚Äì70¬∞F ‚Äî a 20¬∞F differential easily drives the breeze. Morning S/SW, afternoon NE is the dominant daily cycle. GLERL archive shows July has the highest frequency of shifts >45¬∞ in any 3-hr window.' },
        { icon:'üåä', condition:'Convergence zone tactics', text:'The lake breeze convergence front migrates southward through the day. It\'s usually 0.5‚Äì2 miles offshore at noon, reaches the lakefront by 2‚Äì3pm, can push S/SW of Monroe Harbor. Being on the right side of this line is worth 3‚Äì5 boat lengths.' },
        { icon:'üé≠', condition:'Oscillating shifts', text:'Inside the lake breeze: direction oscillates ¬±15‚Äì25¬∞ every 15‚Äì20 minutes. These are sailable oscillations ‚Äî head-up sailing, never overstand. The median period of July direction oscillations at the Crib is ~18 minutes per the archive.' },
        { icon:'‚ö†Ô∏è', condition:'Thunderstorm window', text:'July afternoon thunderstorms are the biggest safety risk. Squall lines track NE; pre-squall wind often goes SE then NNW rapidly. The 3‚Äì6pm window is highest risk. Always have an exit plan and monitor radar.' }
      ],
      confModifier: -12,
      confNote: 'July confidence significantly reduced for direction prediction. Oscillating lake breeze creates high circular variance ‚Äî direction R¬≤ is often <0.3. Speed confidence remains fair when breeze is established.',
      shiftFreqPerHr: 1.9,
    },
    7: { // AUGUST
      name: 'August', emoji: 'üåÖ',
      tagline: 'Lake temps peak ¬∑ breeze weakens ¬∑ humid southerlies return ¬∑ squall season',
      waterTempF: [68, 76],
      waterTempMid: 72,
      dominantDirs: ['S','SSW','SW','NE'],
      avgSpdKts: [6, 11],
      lakeBreezeProbByHour: [0,0,0,0,0,0, 1,2,5,10,17,24, 30,33,30,25,18,11, 6,3,1,0,0,0],
      lakeBreezeSeason: 'waning ‚Äî land-sea differential narrows',
      thunderstormRisk: 'high ‚Äî peak squall season',
      shiftCharacter: 'moderate ‚Äî southerlies more persistent, breeze weaker',
      racingNotes: [
        { icon:'üå°Ô∏è', condition:'Narrowing differential', text:'As lake temps peak at 70‚Äì76¬∞F, the land-sea differential shrinks to 10‚Äì15¬∞F by late August ‚Äî lake breeze becomes weaker and less reliable. When it does fire, it\'s shallower and more easily killed by synoptic flow.' },
        { icon:'üå©Ô∏è', condition:'Peak squall risk', text:'August is the most dangerous month for squall lines on Lake Michigan. Fast-moving MCS (mesoscale convective systems) can produce 40‚Äì60 kt winds with almost no warning. Pre-squall shift: SE, then explosive NNW. Monitor radar obsessively.' },
        { icon:'üíß', condition:'Humid southerlies', text:'Persistent humid S/SSW flow is the dominant August pattern on calm high-pressure days. These are "drifters" ‚Äî 5‚Äì8 kts, hot, humid, with city heat island creating erratic near-shore puffs. Mentally the hardest racing conditions.' },
        { icon:'üéØ', condition:'Tactic: Pressure lanes', text:'In S/SSW < 8 kts, pressure lanes (darker water = more wind) become critical. The offshore lane (away from city) is often 2‚Äì3 kts more pressure than the inshore lane. Commitment to an offshore lane mid-leg can be the race.' }
      ],
      confModifier: -6,
      confNote: 'August confidence moderately reduced. High thunderstorm risk means rapid unforecast changes are possible. Speed confidence better than July but southerly drifter conditions are nearly unpredictable at 60-min range.',
      shiftFreqPerHr: 1.1,
    },
    8: { // SEPTEMBER
      name: 'September', emoji: 'üçÇ',
      tagline: 'Return to synoptic control ¬∑ cleanest pressure of summer ¬∑ lake breeze collapses mid-month',
      waterTempF: [62, 72],
      waterTempMid: 67,
      dominantDirs: ['W','NW','SW','N'],
      avgSpdKts: [9, 16],
      lakeBreezeProbByHour: [0,0,0,0,0,0, 0,1,2,4,6,8, 10,11,9,7,4,2, 1,0,0,0,0,0],
      lakeBreezeSeason: 'closing ‚Äî essentially over after week 2',
      thunderstormRisk: 'low-moderate',
      shiftCharacter: 'low ‚Äî synoptic flows steady, fronts predictable',
      racingNotes: [
        { icon:'üí®', condition:'Best pressure of summer', text:'September post-frontal W/NW is the finest racing wind of the Chicago season ‚Äî 12‚Äì18 kts, building seas, steady direction. Cold fronts arrive every 5‚Äì8 days. The two-day post-frontal window is gold.' },
        { icon:'üåä', condition:'Lake stays warm', text:'Lake temps hold at 65‚Äì70¬∞F into early October. This means the water is still warm enough to generate fog on cold mornings (lake smoke) when polar air mass arrives. Visibility can drop to <0.5 mile in minutes.' },
        { icon:'üåÄ', condition:'Lake breeze collapses', text:'Lake breeze frequency drops from ~30% in early September to near-zero by end of month as land cools. The daily S‚ÜíNE cycle disappears. Racing becomes more like springtime synoptic sailing.' },
        { icon:'üéØ', condition:'Tactic: Front timing', text:'September racing is about front timing. The day-of and day-after a cold front gives the season\'s best racing. Two days after, the high-pressure gradient weakens. Three days after, southerlies return and it\'s drifter territory again.' }
      ],
      confModifier: +8,
      confNote: 'September has the highest prediction confidence of any racing month. Synoptic flows are steady and well-captured by linear regression. Lake breeze variability is minimal after mid-month.',
      shiftFreqPerHr: 0.6,
    }
  },

  // Non-racing months ‚Äî minimal profiles
  other: {
    name: 'Off-Season', emoji: '‚ùÑÔ∏è',
    tagline: 'Outside the May‚ÄìSeptember racing window',
    waterTempMid: 38,
    dominantDirs: ['W','NW'],
    avgSpdKts: [10, 20],
    lakeBreezeProbByHour: Array(24).fill(0),
    racingNotes: [{ icon:'‚õµ', condition:'Off season', text:'Outside the core racing window. Check back in May!' }],
    confModifier: 0,
    confNote: '',
    shiftFreqPerHr: 0.5,
  }
};

function getSeasonalProfile() {
  const month = new Date().getMonth(); // 0-based
  return SEASONAL.profiles[month] || SEASONAL.other;
}

function renderSeasonalPanel() {
  const month = new Date().getMonth();
  const p = getSeasonalProfile();
  const isSeason = !!SEASONAL.profiles[month];

  // Month pill in local panel
  const monthPill = document.getElementById('monthPill');
  const monthTagline = document.getElementById('monthTagline');
  if (monthPill) { monthPill.textContent = `${p.emoji} ${p.name}`; }
  if (monthTagline) { monthTagline.textContent = p.tagline; }

  // Seasonal panel badge
  const smb = document.getElementById('seasonMonthBadge');
  if (smb) smb.textContent = `${p.emoji} ${p.name}`;

  // Water temp
  const wtv = document.getElementById('waterTempVal');
  if (wtv) {
    wtv.textContent = p.waterTempMid ? `${p.waterTempMid}¬∞F` : '‚Äî';
    const wts = document.getElementById('waterTempSrc');
    if (isSeason && p.waterTempF) {
      wts.textContent = `range: ${p.waterTempF[0]}‚Äì${p.waterTempF[1]}¬∞F ¬∑ climatology`;
    }
  }

  // Month calendar strip (all 12 months)
  const strip = document.getElementById('monthStrip');
  if (strip) {
    const mNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const mColors = {4:'#39ff8c',5:'#00d4ff',6:'#ffb830',7:'#ff6b35',8:'#39ff8c'};
    strip.innerHTML = mNames.map((m, i) => {
      const isActive = i === month;
      const isRacing = SEASONAL.profiles[i] !== undefined;
      const col = mColors[i] || '#3a5570';
      return `<div style="
        flex-shrink:0;
        padding:6px 10px;
        border-radius:6px;
        font-size:10px;
        font-family:'Syne',sans-serif;
        font-weight:${isActive ? '800' : '600'};
        letter-spacing:0.06em;
        background:${isActive ? `rgba(${hexToRgb(col)},0.15)` : isRacing ? 'rgba(30,48,80,0.6)' : 'rgba(20,32,52,0.4)'};
        border:1px solid ${isActive ? col : isRacing ? '#2a4060' : '#1a2a3a'};
        color:${isActive ? col : isRacing ? '#5a7a9a' : '#3a5570'};
        cursor:default;
        transition:all 0.2s;
      " title="${isRacing ? SEASONAL.profiles[i].tagline : 'Off-season'}">${m}${isActive ? ' ‚óÄ' : ''}</div>`;
    }).join('');
  }

  // Seasonal stats grid
  const grid = document.getElementById('seasonStatsGrid');
  if (grid && isSeason) {
    const stats = [
      { label: 'Avg Wind Speed', value: `${p.avgSpdKts[0]}‚Äì${p.avgSpdKts[1]} kts`, icon: 'üí®', color: 'var(--accent)' },
      { label: 'Dominant Dirs', value: p.dominantDirs.join(' ¬∑ '), icon: 'üß≠', color: 'var(--accent3)' },
      { label: 'Lake Breeze', value: p.lakeBreezeSeason, icon: 'üåä', color: '#00d4ff' },
      { label: 'Shift Frequency', value: `${p.shiftFreqPerHr.toFixed(1)}√ó/hr avg`, icon: '‚Üª', color: 'var(--warn)' },
      { label: 'Thunderstorm Risk', value: p.thunderstormRisk, icon: '‚õàÔ∏è', color: p.thunderstormRisk.includes('high') ? 'var(--danger)' : p.thunderstormRisk.includes('moderate') ? 'var(--warn)' : 'var(--accent3)' },
      { label: 'Shift Character', value: p.shiftCharacter, icon: 'üìä', color: 'var(--muted)' },
    ];
    grid.innerHTML = stats.map(s => `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;">
        <div style="font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">${s.icon} ${s.label}</div>
        <div style="font-size:12px;font-family:'DM Mono',monospace;color:${s.color};line-height:1.5;">${s.value}</div>
      </div>
    `).join('');
  }

  // Narrative
  const narr = document.getElementById('seasonNarrativeText');
  if (narr && p.racingNotes) {
    narr.innerHTML = p.racingNotes.map(n => `
      <div style="margin-bottom:12px;padding-left:12px;border-left:2px solid rgba(0,212,255,0.2);">
        <span style="color:var(--accent);font-size:12px;">${n.icon} <strong>${n.condition}:</strong></span>
        <span style="color:var(--muted);"> ${n.text}</span>
      </div>
    `).join('');
  }

  // Lake breeze probability hour bars
  const lbBar = document.getElementById('lbProbBar');
  if (lbBar) {
    const probs = p.lakeBreezeProbByHour || Array(24).fill(0);
    const hourlyEvery3 = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21];
    const nowHr = parseInt(new Intl.DateTimeFormat('en-US',{hour:'numeric',hour12:false,timeZone:'America/Chicago'}).format(new Date())) % 24;
    lbBar.innerHTML = hourlyEvery3.map(h => {
      const prob = probs[h] || 0;
      const isNow = h === nowHr;
      const col = prob > 30 ? '#00d4ff' : prob > 15 ? '#39ff8c' : '#3a5570';
      return `<div style="
        flex:1;height:${Math.max(4, prob * 1.1)}%;
        background:${isNow ? 'var(--accent)' : col};
        border-radius:2px 2px 0 0;
        opacity:${isNow ? 1 : 0.7};
        position:relative;
        min-height:4px;
        transition:height 0.4s;
        box-shadow:${isNow ? '0 0 6px var(--accent)' : 'none'};
      " title="${h}:00 CST ‚Äî ${prob}% lake breeze probability"></div>`;
    }).join('');
  }

  // Confidence note
  const confNote = document.getElementById('seasonConfNote');
  if (confNote) {
    const sign = p.confModifier >= 0 ? '+' : '';
    const col = p.confModifier > 0 ? 'var(--accent3)' : p.confModifier < -8 ? 'var(--danger)' : 'var(--warn)';
    confNote.innerHTML = `<strong style="color:${col}">Seasonal Confidence Modifier: ${sign}${p.confModifier}%</strong> ‚Äî ${p.confNote}`;
  }

  // Update seasonal tips in local panel
  const seasonalTips = document.getElementById('seasonalTips');
  if (seasonalTips && p.racingNotes) {
    const tipColors = ['var(--accent)','var(--accent3)','var(--warn)','var(--muted)'];
    seasonalTips.innerHTML = p.racingNotes.slice(0,3).map((n, i) => `
      <div class="tip-card" data-icon="${n.icon}" style="border-left:2px solid ${tipColors[i%tipColors.length]};">
        <div class="tip-condition" style="color:${tipColors[i%tipColors.length]}">${p.name} ¬∑ ${n.condition}</div>
        <div class="tip-text">${n.text}</div>
      </div>
    `).join('');
  }
}

// Apply seasonal modifier to prediction confidence
function applySeasonalConfModifier(baseConf) {
  const p = getSeasonalProfile();
  return Math.min(95, Math.max(12, baseConf + (p.confModifier || 0)));
}

// Hex color to r,g,b string helper for rgba()
function hexToRgb(hex) {
  const clean = hex.replace('#','');
  if (clean.length === 6) {
    const r = parseInt(clean.substring(0,2),16);
    const g = parseInt(clean.substring(2,4),16);
    const b = parseInt(clean.substring(4,6),16);
    return `${r},${g},${b}`;
  }
  return '0,212,255';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SVG TICK MARKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function drawTicks() {
  const g = document.getElementById('ticks');
  for (let i = 0; i < 36; i++) {
    const angle = (i * 10) * Math.PI / 180;
    const isMajor = i % 9 === 0;
    const r1 = 95, r2 = isMajor ? 85 : 90;
    const cx = 100, cy = 100;
    const x1 = cx + r1 * Math.sin(angle);
    const y1 = cy - r1 * Math.cos(angle);
    const x2 = cx + r2 * Math.sin(angle);
    const y2 = cy - r2 * Math.cos(angle);
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', x1); line.setAttribute('y1', y1);
    line.setAttribute('x2', x2); line.setAttribute('y2', y2);
    line.setAttribute('stroke', isMajor ? '#3a5570' : '#1e3050');
    line.setAttribute('stroke-width', isMajor ? '2' : '1');
    g.appendChild(line);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHART MODE TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function setChartMode(mode, btn) {
  chartMode = mode;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  if (parsedData.length) renderChart(parsedData);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

drawTicks();
renderSeasonalPanel();
// Wait for DOM, then load data
document.addEventListener('DOMContentLoaded', () => {
  loadData().catch(err => {
    console.error('Initial data load failed:', err);
    setLiveStatus('error');
    document.getElementById('updateTime').textContent = 'CORS blocked ‚Äî demo mode';
    // Fall back to demo data if live fetch fails
    loadDemoData();
  });
});

fetchArchivePatterns(); // fetch once ‚Äî archive doesn't change during a session
// Auto-refresh every 5 minutes
setInterval(() => {
  loadData().catch(err => console.error('Auto-refresh failed:', err));
}, 300000);
</script>
</body>
</html>
